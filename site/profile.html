<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="config.js"></script>
    <title>Профиль - Bike App</title>
    <link rel="stylesheet" href="style.css?v=7.3">
    <link rel="stylesheet" href="blend.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Стили для модальных окон профиля */
        .modal-content .modal-form-group { text-align: left; margin-bottom: 20px; }
        .modal-content .modal-form-group label { display: block; font-size: 0.9rem; font-weight: 600; color: var(--dark-green); margin-bottom: 8px; }
        .modal-content input.form-input { width: 100%; padding: 16px; background-color: var(--card-bg); border: 2px solid var(--card-bg); border-radius: 16px; font-size: 1rem; color: var(--dark-green); font-family: 'Inter', sans-serif; transition: all 0.2s ease; }
        .modal-content input.form-input:focus { outline: none; border-color: var(--icon-green); background-color: var(--white); }
        .input-group-row { display: flex; gap: 15px; }
        .modal-content #add-card-form { margin-top: 20px; }

        .card-preview { background: linear-gradient(45deg, var(--dark-green), #0a5046); color: white; padding: 20px; border-radius: 12px; margin-top: 20px; }
        .card-number { font-family: monospace; font-size: 1.2rem; letter-spacing: 2px; margin-bottom: 15px; }
        .card-details { display: flex; justify-content: space-between; font-size: 0.9rem; opacity: 0.8; }
        .delete-card-btn { background-color: #fcebeb; color: #e53e3e; width: 100%; font-weight: 600; padding: 14px; margin-top: 20px; }

        .error-message { color: #e53e3e; font-size: 0.9rem; text-align: center; margin-top: -10px; margin-bottom: 15px; display: none; }
        .error-message.visible { display: block; }

        .notifications-content { text-align: center; padding: 20px 0; }
        .notifications-content .icon-wrapper { margin: 0 auto 20px auto; background-color: var(--icon-green); }
        .notifications-content p { color: #556f6b; font-size: 1rem; }

        .notification-badge {
            background-color: #e53e3e;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 5px;
        }

        /* === НОВЫЕ И УЛУЧШЕННЫЕ СТИЛИ ДЛЯ ЧАТА ПОДДЕРЖКИ === */
        .chat-modal .modal-content {
            height: 80vh; /* Увеличиваем высоту */
            max-height: 700px;
            display: flex;
            flex-direction: column;
            padding: 0; /* Убираем внутренние отступы, чтобы элементы прилегали к краям */
        }
        .chat-modal h2 {
            padding: 25px 25px 15px 25px; /* Возвращаем отступы для заголовка */
            flex-shrink: 0;
        }
        .chat-modal .modal-close {
            top: 15px; right: 20px; /* Позиционируем крестик */
        }
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 0 20px 20px 20px; /* Отступы для сообщений */
        }
        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word; /* Перенос длинных слов */
        }
        .user-message {
            align-self: flex-end;
            background-color: var(--dark-green);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        .support-message {
            align-self: flex-start;
            background-color: var(--card-bg);
            color: var(--dark-green);
            border-bottom-left-radius: 4px;
        }
        .chat-input-area {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-top: 1px solid var(--progress-bar-bg);
            background-color: var(--white);
            flex-shrink: 0;
            position: relative; /* <-- ДОБАВЛЕНО для позиционирования меню */
        }
        .chat-attach-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background-color: var(--card-bg);
            color: var(--dark-green);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: background-color 0.2s ease;
        }
        .chat-attach-btn:hover {
            background-color: var(--progress-bar-bg);
        }
        .chat-attach-btn svg {
            fill: currentColor;
        }
        #chat-input-wrapper {
            flex-grow: 1;
            background-color: var(--card-bg);
            border-radius: 22px;
            display: flex;
            align-items: center;
            padding: 0 5px 0 20px;
        }
        #chat-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            font-size: 1rem;
            color: var(--dark-green);
            outline: none;
        }
        #send-chat-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            flex-shrink: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* === НОВЫЕ СТИЛИ ДЛЯ МЕНЮ ПРИКРЕПЛЕНИЯ ФАЙЛОВ === */
        #chat-attach-menu {
            position: absolute;
            bottom: 65px; /* Позиция над кнопкой */
            left: 15px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 10;
            transform: translateY(10px); /* Начальное положение для анимации */
            opacity: 0;
            visibility: hidden;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        #chat-attach-menu.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .attach-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--dark-green);
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }
        .attach-menu-item:hover {
            background-color: var(--card-bg);
        }
        .attach-menu-item svg {
            width: 20px;
            height: 20px;
            stroke: var(--dark-green);
        }

        /* === НОВЫЕ СТИЛИ ДЛЯ ВРЕМЕНИ И СТАТУСА СООБЩЕНИЙ === */
        .message-meta {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
            float: right;
            clear: both;
        }
        .user-message .message-meta {
            color: #a3e0d2;
        }
        .support-message .message-meta {
            color: #718096;
        }
        .message-status {
            font-weight: bold;
            font-size: 1rem;
            line-height: 1;
        }
        .message-status.read {
            color: var(--primary-green);
        }

        /* === ДОПОЛНИТЕЛЬНЫЕ СТИЛИ ДЛЯ ФОРМЫ НАСТРОЕК ОПЛАТЫ === */
        /* Селект и радио в настройках оплаты используют те же отступы, что и поля ввода карты */
        .modal-content select.form-input {
            width: 100%;
            padding: 16px;
            background-color: var(--card-bg);
            border: 2px solid var(--card-bg);
            border-radius: 16px;
            font-size: 1rem;
            color: var(--dark-green);
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        .modal-content select.form-input:focus {
            outline: none;
            border-color: var(--icon-green);
            background-color: var(--white);
        }
        /* Контейнер для тарифов BikePark54 в настройках отображается или скрывается */
        #BikePark54-tariff-options.hidden {
            display: none;
        }
        /* Радиогруппы для выбора провайдера и тарифов */
        .payment-radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .payment-radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-green);
        }
        .BikePark54-tariff-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .BikePark54-tariff-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-green);
        }
    </style>

    <script src="transitions.js" defer></script>
</head>
<body>

<div class="app-screen">
    <div class="app-content">
        <header class="app-header header-centered">
            <h1>Профиль</h1>
        </header>
        <main class="app-main profile-main">
            <div class="profile-header">
                <img src="avatar.png" alt="Аватар пользователя" class="avatar">
                <h2 class="user-name" id="user-name-placeholder">Имя пользователя</h2>
                <p class="user-id">ID: 11071998</p>
                <div id="profile-subscription-status" style="display: none; margin-top: 10px; text-align: left;">
                    <span class="subscription-badge active">Bad Fox</span>
                    <p style="font-size: 0.9rem; color: #556f6b; margin-top: 5px;">Статус: Подписка активна до <span id="profile-subscription-expiry">дата</span></p>
                </div>
            </div>

            <div class="profile-menu">
                <div class="menu-item" data-modal-target="card-modal" style="cursor: pointer;">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                        <span class="menu-item-text">Привязанная карта</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <div class="menu-item" data-modal-target="notifications-modal" style="cursor: pointer;">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <span class="menu-item-text">Уведомления <span id="notifications-count" class="notification-badge" style="display: none;">0</span></span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <div class="menu-item" data-modal-target="support-modal" style="cursor: pointer; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                        <span class="menu-item-text">Поддержка</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <!-- Новый пункт меню для настроек оплаты -->
                <div class="menu-item" data-modal-target="payment-settings-modal" style="cursor: pointer;">
                    <div class="menu-item-left">
                        <!-- Иконка города -->
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        <span class="menu-item-text">Город</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <div class="menu-item" data-modal-target="subscription-modal" style="cursor: pointer;">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <div class="menu-item-text">
                            <span>Подписка Bad Fox</span>
                            <span id="subscription-status" class="subscription-badge" style="display: none;">Активна</span>
                        </div>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <a href="https://t.me/BikePark54_wello" target="_blank" class="menu-item">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        <span class="menu-item-text">Написать в Telegram</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </a>
            </div>
            <button class="logout-button" id="logout-btn">Выйти из аккаунта</button>
        </main>
    </div>
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </a>
        <a href="stats.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
        </a>
        <a href="map.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        </a>
        <div class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
    </nav>
</div>
<!-- Модальные окна -->
<div id="card-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h2 id="card-modal-title">Способ оплаты</h2>

        <div id="card-view-container">
            <!-- JS will render content here -->
        </div>
    </div>
</div>
<div id="notifications-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h2>Уведомления</h2>
        <div class="notifications-content">
            <div class="icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            </div>
            <div id="notifications-list">
                <p>У вас 0 новых уведомлений.</p>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для подписания договора (ИСПРАВЛЕНО) -->
<div id="contract-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column;">
        <!-- "Шапка" окна, которая не скроллится -->
        <div style="flex-shrink: 0; padding-bottom: 10px; position: relative;">
             <button class="modal-close">&times;</button>
             <h2>Подписание</h2>
        </div>

        <!-- Основная часть, которая будет прокручиваться при необходимости -->
        <div class="modal-body-scroll" style="flex-grow: 1; overflow-y: auto; padding: 0 10px 10px 0;">
            <div id="contract-content"></div>

            <!-- Обновленный блок для подписи -->
            <div id="signature-section" style="text-align: center; margin-top: 20px;">
                <p style="font-weight: 600; color: var(--dark-green); margin-bottom: 10px;">Ваша подпись</p>
                <canvas id="signature-canvas" width="400" height="200" style="border: 1px solid #ccc; border-radius: 8px; max-width: 100%; touch-action: none;"></canvas>

                <!-- Контейнер для кнопок с отступом -->
                <div class="signature-buttons" style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
                    <button id="clear-signature-btn" class="btn btn-secondary">Очистить подпись</button>
                    <button id="sign-contract-btn" class="btn btn-primary">Подписал</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ОБНОВЛЕННЫЙ HTML ДЛЯ ЧАТА ПОДДЕРЖКИ -->
<div id="support-modal" class="modal-overlay hidden chat-modal">
    <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h2>Поддержка</h2>
        <div class="chat-history" id="chat-history">
            <div class="chat-message support-message">Здравствуйте! Чем можем помочь?</div>
        </div>
        <div class="chat-input-area">
            <!-- НОВЫЙ HTML ДЛЯ МЕНЮ -->
            <!-- Скрытый инпут для выбора файлов -->
            <input type="file" id="chat-file-input" style="display: none;" multiple>

            <div id="chat-attach-menu">
                <a href="#" class="attach-menu-item" id="attach-photo-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    <span>Фото или видео</span>
                </a>
                <a href="#" class="attach-menu-item" id="attach-file-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                    <span>Файл</span>
                </a>
            </div>

            <button class="chat-attach-btn" id="chat-attach-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Заменим иконку на более подходящий "плюсик" или "скрепку" -->
                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div id="chat-input-wrapper">
                <input type="text" id="chat-input" placeholder="Сообщение...">
                <button class="btn btn-primary" id="send-chat-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Модальное окно для выбора города -->
    <div id="payment-settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>Город</h2>
            <form id="payment-settings-form">
                <div class="modal-form-group">
                    <label for="city-select">Город</label>
                    <select id="city-select" class="form-input">
                        <option value="Новосибирск" selected>Новосибирск</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Сохранить</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно подписки Bad Fox -->
    <div id="subscription-modal" class="modal-overlay hidden">
        <div class="modal-content subscription-modal-content">
            <button class="modal-close">&times;</button>
            <h2 style="color: var(--icon-orange); margin-bottom: 15px;">Bad Fox</h2>
            <div class="subscription-content">
                <div class="subscription-header">
                    <div class="subscription-price">
                        <span class="price-amount">599₽</span>
                        <span class="price-period">/месяц</span>
                    </div>
                    <div class="price-yearly">
                        <span class="yearly-price">499₽/месяц</span>
                        <span class="yearly-note">при годовой оплате</span>
                    </div>
                </div>
                
                <div class="subscription-benefits">
                    <h3 style="margin: 20px 0 15px 0; color: var(--dark-text); font-size: 1.1rem;">Что входит в подписку:</h3>
                    
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                        <div class="benefit-text">
                            <strong>Скидка 10% на всю аренду</strong>
                            <p>Экономия на каждой секунде поездки на любом велосипеде и аренде любой АКБ</p>
                        </div>
                    </div>

                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div class="benefit-text">
                            <strong>+25% бонусных очков</strong>
                            <p>За каждую завершенную аренду, чистый возврат, отсутствие повреждений и своевременный возврат АКБ</p>
                        </div>
                    </div>

                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 12l2 2 4-4"/>
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                        </div>
                        <div class="benefit-text">
                            <strong>Приоритетный доступ</strong>
                            <p>Свободные велосипеды отображаются на 5 минут раньше, значок "Bad Fox" в профиле</p>
                        </div>
                    </div>

                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                        </div>
                        <div class="benefit-text">
                            <strong>Гибкие условия</strong>
                            <p>Можете арендовать велосипед на 1 день или дольше без ограничений</p>
                        </div>
                    </div>

                <div class="subscription-trial">
                    <p style="color: var(--icon-orange); font-weight: 600; margin-bottom: 15px;">Первые 3 дня — бесплатно!</p>
                    <p style="font-size: 0.85rem; color: #556f6b; margin-bottom: 20px;">Подписка автоматически продлевается. Можно отменить в любой момент в Личном кабинете.</p>
                </div>

                <div class="subscription-actions" id="subscription-actions">
                    <button class="btn btn-primary" id="subscribe-btn" style="margin-bottom: 15px;">
                        Подключить за 599₽/мес
                    </button>
                    <button class="btn btn-secondary" id="cancel-subscription-btn" style="display: none; color: #e53e3e; border-color: #fcebeb;">
                        Отменить подписку
                    </button>
                </div>

                <div class="subscription-status" id="subscription-status-display" style="display: none; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ea5e9" stroke-width="2">
                            <path d="M9 12l2 2 4-4"/>
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <div>
                            <strong style="color: #0ea5e9;">Подписка активна</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #556f6b;">Действует до <span id="subscription-expiry">дата</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Главное меню BikePark54 -->
    <div id="main-menu-overlay" class="menu-overlay hidden" role="dialog" aria-modal="true">
        <div class="menu-container">
            <button id="main-menu-close-btn" class="menu-close-btn" aria-label="Закрыть меню">&times;</button>
            <div class="menu-items">
                <button class="menu-item-btn primary" id="menu-tariffs-btn">Тарифы</button>
                <button class="menu-item-btn secondary" id="menu-my-rentals-btn">Мои аренды</button>
                <button class="menu-item-btn secondary" id="menu-topup-btn">Пополнить баланс</button>
                <button class="menu-item-btn secondary" id="menu-map-btn">Карта</button>
                <button class="menu-item-btn secondary" id="menu-stats-btn">Статистика</button>
                <button class="menu-item-btn secondary" id="menu-profile-btn">Профиль</button>
                <button class="menu-item-btn secondary" id="menu-support-btn">Поддержка/FAQ</button>
            </div>
        </div>
    </div>

    <div id="card-saved-toast" class="toast-container toast-success hidden"><p class="toast-message">Карта успешно привязана!</p></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.41.0/dist/umd/supabase.min.js"></script>
        <script>
    const SUPABASE_URL = window.APP_CONFIG.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.APP_CONFIG.SUPABASE_ANON_KEY;
    // We no longer use a global API_BASE_URL for all requests,
    // since they go to different servers.
    // const API_BASE_URL = 'https://serverdogovor.onrender.com';

    // Define a constant specifically for contract requests
    const CONTRACTS_API_URL = window.APP_CONFIG.CONTRACTS_API_URL;

    document.addEventListener('DOMContentLoaded', () => {
        if (window.location.hash === '#support') {
            setTimeout(() => {
                openModal('support-modal');
            }, 300);
        }
        if (window.location.hash === '#card-modal') {
            setTimeout(() => {
                openModal('card-modal');
            }, 300);
        }

        // --- НОВЫЙ КОД: Обработка deeplink из Telegram ---
        try {
            const tg = window.Telegram.WebApp;
            tg.ready(); // Сообщаем Telegram, что приложение готово

            // Проверяем, был ли передан параметр `start_param`
            if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
                const startParam = tg.initDataUnsafe.start_param;

                // Если параметр равен 'notifications', открываем модальное окно
                if (startParam === 'notifications') {
                    // Небольшая задержка, чтобы UI успел прогрузиться
                    setTimeout(() => {
                        openModal('notifications-modal');
                    }, 300); // 300 миллисекунд
                }
            }
        } catch (error) {
            console.log("Приложение открыто не в Telegram или произошла ошибка:", error);
        }
        // --- КОНЕЦ НОВОГО КОДА ---
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ОБЩАЯ ЛОГИКА МОДАЛЬНЫХ ОКОН ---
        const modalTriggers = document.querySelectorAll('[data-modal-target]');
        const modals = document.querySelectorAll('.modal-overlay');
        const modalCloses = document.querySelectorAll('.modal-close');

        const openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            if (modalId === 'card-modal') updateCardView();
            if (modalId === 'payment-settings-modal') updatePaymentSettingsView();
            if (modalId === 'notifications-modal') loadNotifications();
            if (modalId === 'support-modal') initializeSupportChat();

            modal.classList.remove('hidden');
        };

        const closeModal = (modal) => {
            if (modal) modal.classList.add('hidden');
        };

        modalTriggers.forEach(trigger => trigger.addEventListener('click', (e) => { e.preventDefault(); openModal(trigger.dataset.modalTarget); }));
        modalCloses.forEach(button => button.addEventListener('click', () => closeModal(button.closest('.modal-overlay'))));
        modals.forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); }));

        // --- ПРОВЕРКА АВТОРИЗАЦИИ И ДАННЫЕ ПОЛЬЗОВАТЕЛЯ ---
        if (localStorage.getItem('isRegistered') !== 'true') {
            window.location.replace('start.html');
            return;
        }

        const userName = localStorage.getItem('userName');
        if (userName) document.getElementById('user-name-placeholder').textContent = userName;
        const userId = localStorage.getItem('userId');
        if (userId) document.querySelector('.user-id').textContent = `ID: ${userId.slice(-8)}`;
        
        // --- TOAST УВЕДОМЛЕНИЕ О КАРТЕ ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('card_saved') === 'true') {
            const toast = document.getElementById('card-saved-toast');
            if(toast) {
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            }
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- ЛОГИКА КНОПКИ ВЫХОДА ---
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                if (confirm('Вы уверены, что хотите выйти из аккаунта?')) {
                    localStorage.clear();
                    window.location.replace('start.html');
                }
            });
        }
        
        // ===============================================================
        // === НАЧАЛО ВОССТАНОВЛЕННОГО БЛОКА: ПРИВЯЗАННАЯ КАРТА =========
        // ===============================================================
        const cardViewContainer = document.getElementById('card-view-container');

        const handleAddCardClick = async () => {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('Ошибка: не удалось определить пользователя.');
                return;
            }
            const btn = document.getElementById('add-card-btn');
            if(btn) {
                btn.disabled = true;
                btn.textContent = 'Создаем ссылку...';
            }
            
            try {
                // ПРИМЕЧАНИЕ: убедитесь, что ваш API-эндпоинт для создания ссылки правильный.
                const response = await fetch(`/api/payments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save-card', userId: userId })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Ошибка сервера');
                
                if (data.confirmation_url) {
                    window.location.href = data.confirmation_url;
                } else {
                    throw new Error('Не получена ссылка для привязки карты.');
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Привязать карту';
                }
            }
        };

        const handleUnbindClick = async () => {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('Ошибка: не удалось определить пользователя.');
                return;
            }
            if (!confirm('Вы уверены, что хотите отвязать способ оплаты?')) {
                return;
            }
            const btn = document.getElementById('unbind-card-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Отвязываем...';
            }
            try {
                // Логика отвязки через ваш API
                const response = await fetch(`/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'unbind-payment-method', userId: userId })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Не удалось отвязать способ оплаты');
                }
                alert('Способ оплаты успешно отвязан.');
                updateCardView();
            } catch (error) {
                alert('Ошибка: ' + error.message);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Отвязать карту';
                }
            }
        };
        
        let isUpdatingCardView = false;
        const updateCardView = async () => {
            if (isUpdatingCardView) return;
            isUpdatingCardView = true;

            const userId = localStorage.getItem('userId');
            if (!userId || !cardViewContainer) {
                isUpdatingCardView = false;
                return;
            }
            
            try {
                // --- ИЗМЕНЕНИЕ: Запрашиваем данные через API ---
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-payment-method', userId: userId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to get payment method');

                const paymentMethod = result.payment_method;
                if (!paymentMethod) throw new Error('No saved method');

                let cardTitle = '';
                let cardSubtitle = '';
                if (paymentMethod.type === 'bank_card' && paymentMethod.card) {
                    cardTitle = `**** **** **** ${paymentMethod.card.last4}`;
                    cardSubtitle = `${paymentMethod.card.card_type || 'Карта'}`;
                } else if (paymentMethod.type === 'sbp') {
                    cardTitle = 'Система быстрых платежей';
                    cardSubtitle = 'Привязан счёт СБП';
                } else {
                    cardTitle = paymentMethod.display_name || 'Сохраненный метод';
                    cardSubtitle = 'Карта для автосписаний';
                }

                cardViewContainer.innerHTML = `
                    <div id="card-display-view">
                        <div class="card-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px;">
                            <div class="card-number" style="font-size: 18px; font-weight: 600; margin-bottom: 8px; letter-spacing: 2px;">${cardTitle}</div>
                            <div class="card-details" style="display: flex; justify-content: space-between; font-size: 14px; opacity: 0.95;">
                                <span>${cardSubtitle}</span>
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px;">Привязана</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="unbind-card-btn" style="margin-top: 20px;">Отвязать карту</button>
                    </div>`;
                document.getElementById('unbind-card-btn').addEventListener('click', handleUnbindClick);

            } catch (error) {
                cardViewContainer.innerHTML = `
                    <div id="card-form-view">
                        <p style="margin-bottom: 20px; color: var(--dark-green);">
                            У вас еще нет привязанной карты. Вы можете привязать ее сейчас или она будет автоматически сохранена после первой успешной оплаты.
                        </p>
                        <button class="btn btn-primary" id="add-card-btn" style="width: 100%;">Привязать карту</button>
                    </div>`;
                document.getElementById('add-card-btn').addEventListener('click', handleAddCardClick);
            } finally {
                isUpdatingCardView = false;
            }
        };
        // ===============================================================
        // === КОНЕЦ ВОССТАНОВЛЕННОГО БЛОКА: ПРИВЯЗАННАЯ КАРТА =========
        // ===============================================================


        // --- ВАША НОВАЯ ЛОГИКА УВЕДОМЛЕНИЙ И ПОДПИСАНИЯ ---
        async function updateNotificationsCount() {
            const userId = localStorage.getItem('userId');
            if (!userId) return;
            try {
                const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-pending-contracts', userId: userId })
                });
                const result = await response.json();
                if (!response.ok) return;

                const notifications = result.notifications || [];
                const countEl = document.getElementById('notifications-count');
                if (notifications.length > 0) {
                    countEl.textContent = notifications.length;
                    countEl.style.display = 'inline';
                } else {
                    countEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating notifications count:', error);
            }
        }
        
        async function loadNotifications() {
            const userId = localStorage.getItem('userId');
            if (!userId) return;

            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '<p>Загрузка уведомлений...</p>';

            try {
                const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-pending-contracts', userId: userId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Server error');
                
                const notifications = result.notifications || [];
                const countEl = document.getElementById('notifications-count');

                if (notifications.length > 0) {
                    countEl.textContent = notifications.length;
                    countEl.style.display = 'inline';
                    notificationsList.innerHTML = '';
                    notifications.forEach(item => {
                        const notification = document.createElement('div');
                        notification.className = 'notification-item'; // Используем div для лучшей стилизации
                        if (item.status === 'awaiting_contract_signing') {
                            notification.innerHTML = `
                                <p>Необходимо подписать договор для аренды велосипеда.</p>
                                <button class="btn btn-primary sign-initial-contract-btn" data-rental-id="${item.id}" style="margin-top: 10px;">Подписать</button>
                            `;
                        } else if (item.status === 'awaiting_return_signature') {
                            notification.innerHTML = `
                                <p>Акт сдачи-приемки велосипеда готов к подписанию.</p>
                                <button class="btn btn-primary sign-return-act-btn" data-rental-id="${item.id}" style="margin-top: 10px;">Подписать Акт</button>
                            `;
                        }
                        notificationsList.appendChild(notification);
                    });
                } else {
                    countEl.style.display = 'none';
                    notificationsList.innerHTML = '<p>У вас нет новых уведомлений.</p>';
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                notificationsList.innerHTML = `<p style="color:red;">Ошибка загрузки уведомлений.</p>`;
            }
        }

        document.addEventListener('click', async (e) => {
            if (e.target.matches('.sign-initial-contract-btn')) {
                openContractModal(e.target.dataset.rentalId);
            }
            if (e.target.matches('.sign-return-act-btn')) {
                openReturnActModal(e.target.dataset.rentalId);
            }
            if (e.target.matches('#contract-modal .modal-close')) {
                document.getElementById('contract-modal').classList.add('hidden');
            }
        });

        async function openContractModal(rentalId) {
            try {
                const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-contract-details', userId, rentalId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Server error');
                
                document.getElementById('contract-content').innerHTML = generateContractHTML(result.rental);
                document.getElementById('contract-modal').classList.remove('hidden');
                setupSignatureCanvas(rentalId, 'confirm-contract');
            } catch (error) {
                alert('Ошибка загрузки договора: ' + error.message);
            }
        }

        async function openReturnActModal(rentalId) {
            try {
                const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-contract-details', userId, rentalId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Server error');

                const defects = result.rental.extra_data?.defects || [];
                document.getElementById('contract-content').innerHTML = generateReturnActHTML(result.rental, defects);
                document.getElementById('contract-modal').classList.remove('hidden');
                setupSignatureCanvas(rentalId, 'confirm-return-act');
            } catch (error) {
                alert('Ошибка загрузки акта сдачи: ' + error.message);
            }
        }

        function setupSignatureCanvas(rentalId, action) {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            let drawing = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const startDrawing = (e) => { e.preventDefault(); drawing = true; const { x, y } = getCoords(e); ctx.beginPath(); ctx.moveTo(x, y); };
            const draw = (e) => { if (!drawing) return; e.preventDefault(); const { x, y } = getCoords(e); ctx.lineTo(x, y); ctx.stroke(); };
            const stopDrawing = () => { drawing = false; };
            const getCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : e;
                return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
            };

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            const clearBtn = document.getElementById('clear-signature-btn');
            const signBtn = document.getElementById('sign-contract-btn');
            const newClearBtn = clearBtn.cloneNode(true);
            const newSignBtn = signBtn.cloneNode(true);
            newSignBtn.textContent = 'Подписал'; // Убедимся что текст кнопки правильный
            clearBtn.parentNode.replaceChild(newClearBtn, clearBtn);
            signBtn.parentNode.replaceChild(newSignBtn, signBtn);

            newClearBtn.addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));

            newSignBtn.addEventListener('click', async () => {
                if (ctx.getImageData(0, 0, canvas.width, canvas.height).data.some(p => p !== 0)) {
                    const signatureData = canvas.toDataURL('image/png');
                    try {
                        const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action, userId, rentalId, signatureData })
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error || 'Server error');
                        alert(action === 'confirm-contract' ? 'Договор подписан!' : 'Акт сдачи подписан!');
                        document.getElementById('contract-modal').classList.add('hidden');
                        window.location.reload();
                    } catch (error) {
                        alert('Ошибка подписания: ' + error.message);
                    }
                } else {
                    alert('Пожалуйста, поставьте вашу подпись.');
                }
            });
        }

        function generateContractHTML(rental) {
            const client = rental.clients;
            const bike = rental.bikes;
            const now = new Date();

            let passport = {}; // Создаем пустой объект по умолчанию

            // --- ЭТО КЛЮЧЕВОЕ ИСПРАВЛЕНИЕ ---
            if (client?.recognized_passport_data) {
                const passportData = client.recognized_passport_data;

                // Проверяем тип данных. Если это уже объект, просто используем его.
                // Если это строка, тогда пытаемся парсить.
                if (typeof passportData === 'object' && passportData !== null) {
                    passport = passportData; // Данные уже являются объектом
                } else if (typeof passportData === 'string') {
                    try {
                        passport = JSON.parse(passportData); // Данные - это строка, парсим ее
                    } catch (e) {
                        console.error("Failed to parse passport data string:", e);
                        // В случае ошибки парсинга, passport останется пустым
                    }
                }
            }
            // --- КОНЕЦ ИСПРАВЛЕНИЯ ---

            const passportNumber = (passport.series || passport.number)
                ? `${passport.series || ''} ${passport.number || ''}`.trim()
                : 'N/A';

            const batteryNumbers = Array.isArray(bike?.battery_numbers) ? bike.battery_numbers.join(', ') : (bike?.battery_numbers || 'N/A');

            return `
                <div style="text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 20px;">
                    Акт приема-передачи<br>
                    (Приложение №1 к Договору проката)
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.9em;">
                    <span>г. ${client?.city || 'Москва'}</span>
                    <span>${now.toLocaleDateString('ru-RU')}</span>
                </div>
                <h4 style="margin-top: 20px; margin-bottom: 10px;">1. Оборудование</h4>
                <table border="1" style="width:100%; border-collapse: collapse; margin-bottom: 20px; text-align: left; font-size: 0.9em;">
                    <tbody style="text-align: left;">
                        <tr><th style="padding: 8px; width: 40%;">Наименование</th><td style="padding: 8px;">${bike?.model_name || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Номер рамы</th><td style="padding: 8px;">${bike?.frame_number || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Номера аккумуляторов</th><td style="padding: 8px;">${batteryNumbers}</td></tr>
                        <tr><th style="padding: 8px;">Рег. номер</th><td style="padding: 8px;">${bike?.registration_number || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Номер IOT</th><td style="padding: 8px;">${bike?.iot_device_id || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Доп. оборудование</th><td style="padding: 8px;">${bike?.additional_equipment || 'N/A'}</td></tr>
                    </tbody>
                </table>
                <h4 style="margin-top: 20px; margin-bottom: 10px;">2. Арендатор</h4>
                <table border="1" style="width:100%; border-collapse: collapse; margin-bottom: 20px; text-align: left; font-size: 0.9em;">
                    <tbody style="text-align: left;">
                        <tr><th style="padding: 8px; width: 40%;">ФИО</th><td style="padding: 8px;">${client?.name || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Дата рождения</th><td style="padding: 8px;">${passport.birth_date || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Паспорт</th><td style="padding: 8px;">${passportNumber}</td></tr>
                        <tr><th style="padding: 8px;">Кем выдан</th><td style="padding: 8px;">${passport.issuing_authority || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Дата выдачи</th><td style="padding: 8px;">${passport.issue_date || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Адрес регистрации</th><td style="padding: 8px;">${passport.registration_address || 'N/A'}</td></tr>
                    </tbody>
                </table>
                <p style="font-size: 0.9em; margin-top: 20px;">Инструктаж пройден, с условиями согласен, техника и оборудование комплектны, на момент передачи исправны, нареканий нет.</p>
            `;
        }

        function generateReturnActHTML(rental, defects) {
            const client = rental.clients;
            const bike = rental.bikes;
            const now = new Date();
            const batteryNumbers = Array.isArray(bike?.battery_numbers) ? bike.battery_numbers.join(', ') : (bike?.battery_numbers || 'N/A');
            const defectsHTML = defects && defects.length > 0 
                ? `<h4 style="margin-top: 20px; margin-bottom: 10px;">Выявленные неисправности</h4><ul style="padding-left: 20px; margin-bottom: 20px; font-size: 0.9em;">${defects.map(d => `<li>${d}</li>`).join('')}</ul>`
                : '<p style="font-size: 0.9em; margin-top: 20px;">Неисправности на момент сдачи не выявлены.</p>';

            return `
                <div style="text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 20px;">
                    Акт приема-передачи (возврата)<br>
                    (Приложение №2 к Договору проката)
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.9em;">
                    <span>г. ${client?.city || 'Москва'}</span>
                    <span>${now.toLocaleDateString('ru-RU')}</span>
                </div>
                <h4 style="margin-top: 20px; margin-bottom: 10px;">1. Оборудование</h4>
                <table border="1" style="width:100%; border-collapse: collapse; margin-bottom: 20px; text-align: left; font-size: 0.9em;">
                    <tbody>
                        <tr><th style="padding: 8px; width: 40%;">Наименование</th><td style="padding: 8px;">${bike?.model_name || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Номер рамы</th><td style="padding: 8px;">${bike?.frame_number || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Номера аккумуляторов</th><td style="padding: 8px;">${batteryNumbers}</td></tr>
                        <tr><th style="padding: 8px;">Рег. номер</th><td style="padding: 8px;">${bike?.registration_number || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Номер IOT</th><td style="padding: 8px;">${bike?.iot_device_id || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">Доп. оборудование</th><td style="padding: 8px;">${bike?.additional_equipment || 'N/A'}</td></tr>
                    </tbody>
                </table>
                ${defectsHTML}
                <p style="font-size: 0.9em; margin-top: 20px;">Арендатор технику и оборудование передал. Арендодатель технику и оборудование получил. Претензий стороны друг к другу не имеют.</p>
            `;
        }

        // ===============================================================
        // === НАЧАЛО ВОССТАНОВЛЕННОГО БЛОКА: ЧАТ ПОДДЕРЖКИ =============
        // ===============================================================
        const supportModal = document.getElementById('support-modal');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatAttachBtn = document.getElementById('chat-attach-btn');
        const chatAttachMenu = document.getElementById('chat-attach-menu');
        const chatFileInput = document.getElementById('chat-file-input');
        const attachPhotoBtn = document.getElementById('attach-photo-btn');
        const attachFileBtn = document.getElementById('attach-file-btn');

        let currentChatSubscription = null;
        let anonymousChatId = localStorage.getItem('anonymousChatId');
        if (!anonymousChatId) {
            anonymousChatId = `anon_${self.crypto.randomUUID()}`;
            localStorage.setItem('anonymousChatId', anonymousChatId);
        }

        function initializeSupportChat() {
            loadChatHistory();
            subscribeToChat();
        }
    
        const addChatMessage = (message) => {
            const senderClass = message.sender === 'user' ? 'user-message' : 'support-message';
            const messageEl = document.createElement('div');
            messageEl.dataset.messageId = message.id;
            messageEl.classList.add('chat-message', senderClass);

            const time = new Date(message.created_at || Date.now()).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            let contentHTML = '';
            if (message.file_url) {
                if (message.file_type && message.file_type.startsWith('image/')) {
                    contentHTML = `<img src="${message.file_url}" style="max-width: 100%; border-radius: 12px; cursor: pointer;" onclick="window.open('${message.file_url}', '_blank')">`;
                } else {
                    contentHTML = `<a href="${message.file_url}" target="_blank" style="color: inherit; text-decoration: underline;">Прикрепленный файл: ${message.message_text || 'файл'}</a>`;
                }
            } else {
                contentHTML = message.message_text;
            }

            const statusClass = message.is_read ? 'read' : '';
            const statusCheckmarks = message.is_read ? '✓✓' : '✓';
            const statusHTML = message.sender === 'user' ? `<span class="message-status ${statusClass}">${statusCheckmarks}</span>` : '';

            messageEl.innerHTML = `
                <div>${contentHTML}</div>
                <div class="message-meta">
                    <span class="message-time">${time}</span>
                    ${statusHTML}
                </div>`;

            chatHistory.appendChild(messageEl);
            chatHistory.scrollTo({ top: chatHistory.scrollHeight, behavior: 'smooth' });
        };

        async function loadChatHistory() {
            chatHistory.innerHTML = '<p style="text-align:center;">Загрузка...</p>';
            const userId = localStorage.getItem('userId');
            const filterField = userId ? 'client_id' : 'anonymous_chat_id';
            const filterValue = userId || anonymousChatId;
            
            await supabase.from('support_messages').update({ is_read: true }).eq(filterField, filterValue).eq('sender', 'admin').eq('is_read', false);
            const { data, error } = await supabase.from('support_messages').select('*').eq(filterField, filterValue).order('created_at');

            chatHistory.innerHTML = '';
            if (error) {
                console.error("Ошибка загрузки чата:", error);
                chatHistory.textContent = 'Не удалось загрузить историю.';
                return;
            }
            data.forEach(addChatMessage);
        }

        const sendMessage = async (text, file = null) => {
            const userId = localStorage.getItem('userId');
            let fileUrl = null, fileType = null;
            let messageText = text;

            if (file) {
                const filePath = `${userId || anonymousChatId}/${Date.now()}_${file.name}`;
                const { error: uploadError } = await supabase.storage.from('support_files').upload(filePath, file);
                if (uploadError) { alert('Не удалось загрузить файл: ' + uploadError.message); return; }
                const { data: urlData } = supabase.storage.from('support_files').getPublicUrl(filePath);
                fileUrl = urlData.publicUrl;
                fileType = file.type;
                if (!messageText) messageText = file.name;
            }

            if (!messageText) return;

            const payload = {
                id: self.crypto.randomUUID(),
                sender: 'user', message_text: messageText, file_url: fileUrl, file_type: fileType,
                client_id: userId, anonymous_chat_id: !userId ? anonymousChatId : null,
                created_at: new Date().toISOString(), is_read: false
            };

            addChatMessage(payload); 
            chatInput.value = '';

            const { error } = await supabase.from('support_messages').insert(payload);
            if (error) alert('Не удалось отправить сообщение: ' + error.message);
        };

        function subscribeToChat() {
            if (currentChatSubscription) supabase.removeChannel(currentChatSubscription);

            const userId = localStorage.getItem('userId');
            const filter = userId ? `client_id=eq.${userId}` : `anonymous_chat_id=eq.${anonymousChatId}`;

            currentChatSubscription = supabase.channel(`support-chat-${userId || anonymousChatId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'support_messages', filter }, (payload) => {
                    if (payload.new.sender === 'admin') addChatMessage(payload.new);
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'support_messages', filter }, (payload) => {
                    if (payload.new.sender === 'user' && payload.new.is_read) {
                        const messageEl = chatHistory.querySelector(`[data-message-id='${payload.new.id}']`);
                        const statusEl = messageEl?.querySelector('.message-status');
                        if (statusEl) {
                            statusEl.textContent = '✓✓';
                            statusEl.classList.add('read');
                        }
                    }
                })
                .subscribe();
        }

        sendChatBtn.addEventListener('click', () => sendMessage(chatInput.value.trim()));
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(chatInput.value.trim()); } });
        chatAttachBtn.addEventListener('click', (e) => { e.stopPropagation(); chatAttachMenu.classList.toggle('visible'); });
        document.addEventListener('click', (e) => { if (!chatAttachBtn.contains(e.target) && !chatAttachMenu.contains(e.target)) chatAttachMenu.classList.remove('visible'); });
        attachPhotoBtn.addEventListener('click', () => { chatFileInput.accept = "image/*,video/*"; chatFileInput.click(); });
        attachFileBtn.addEventListener('click', () => { chatFileInput.accept = "*/*"; chatFileInput.click(); });
        chatFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) sendMessage(`Загрузка файла: ${file.name}...`, file); chatAttachMenu.classList.remove('visible'); e.target.value = null; });
        // ===============================================================
        // === КОНЕЦ ВОССТАНОВЛЕННОГО БЛОКА: ЧАТ ПОДДЕРЖКИ ===============
        // ===============================================================


        // ===============================================================
        // === НАЧАЛО ВОССТАНОВЛЕННОГО БЛОКА: НАСТРОЙКИ ОПЛАТЫ ==========
        // ===============================================================
        const citySelect = document.getElementById('city-select');
        const providerRadios = document.querySelectorAll('input[name="provider"]');
        const paymentSettingsForm = document.getElementById('payment-settings-form');

        function updatePaymentSettingsView() {
            const savedCity = localStorage.getItem('selectedCity');
            if (savedCity && citySelect) citySelect.value = savedCity;
            
            const savedProvider = localStorage.getItem('paymentProvider') || 'BikePark54';
            if (providerRadios) providerRadios.forEach(r => { r.checked = (r.value === savedProvider); });
        }

        if (paymentSettingsForm) {
            paymentSettingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedCity = citySelect.value;
                const provider = document.querySelector('input[name="provider"]:checked').value;
                
                localStorage.setItem('selectedCity', selectedCity);
                localStorage.setItem('paymentProvider', provider);
                localStorage.removeItem('BikePark54Tariff'); 
                
                closeModal(document.getElementById('payment-settings-modal'));
            });
        }
        // ===============================================================
        // === КОНЕЦ ВОССТАНОВЛЕННОГО БЛОКА: НАСТРОЙКИ ОПЛАТЫ ============
        // ===============================================================


        // Первичный запуск функций при загрузке страницы
        updateNotificationsCount();
        loadSubscriptionStatus();
    });

    // === ЛОГИКА ПОДПИСКИ BAD FOX ===
    let isSubscriptionUpdating = false;

    // Функция загрузки статуса подписки
    async function loadSubscriptionStatus() {
        const userId = localStorage.getItem('userId');
        if (!userId) return;

        try {
            // Получаем статус подписки (в реальном приложении - запрос к API)
            const subscriptionData = await getSubscriptionStatus(userId);
            updateSubscriptionUI(subscriptionData);
        } catch (error) {
            console.error('Ошибка загрузки статуса подписки:', error);
        }
    }

    // Функция получения статуса подписки (заглушка)
    async function getSubscriptionStatus(userId) {
        // В реальном приложении здесь был бы запрос к API
        // const response = await fetch('/api/subscription', {...});
        // return await response.json();
        
        // Для демо используем localStorage
        const saved = localStorage.getItem(`bad_fox_subscription_${userId}`);
        if (saved) {
            const data = JSON.parse(saved);
            if (new Date(data.expiryDate) > new Date()) {
                return {
                    isActive: true,
                    expiryDate: data.expiryDate,
                    startDate: data.startDate
                };
            }
        }
        
        return { isActive: false };
    }

    // Обновление UI подписки
    function updateSubscriptionUI(subscriptionData) {
        const subscriptionStatus = document.getElementById('subscription-status');
        const profileSubscriptionStatus = document.getElementById('profile-subscription-status');
        const subscriptionExpiry = document.getElementById('subscription-expiry');
        const profileSubscriptionExpiry = document.getElementById('profile-subscription-expiry');
        const subscribeBtn = document.getElementById('subscribe-btn');
        const cancelBtn = document.getElementById('cancel-subscription-btn');
        const subscriptionStatusDisplay = document.getElementById('subscription-status-display');
        const actionsContainer = document.getElementById('subscription-actions');

        if (subscriptionData.isActive) {
            // Подписка активна
            if (subscriptionStatus) {
                subscriptionStatus.textContent = 'Активна';
                subscriptionStatus.style.display = 'inline-block';
            }
            
            if (profileSubscriptionStatus) {
                profileSubscriptionStatus.style.display = 'block';
                if (subscriptionExpiry) {
                    const expiryDate = new Date(subscriptionData.expiryDate);
                    const formattedDate = expiryDate.toLocaleDateString('ru-RU', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    profileSubscriptionExpiry.textContent = formattedDate;
                    subscriptionExpiry.textContent = formattedDate;
                }
            }

            // Обновляем модальное окно
            if (subscriptionStatusDisplay) {
                subscriptionStatusDisplay.style.display = 'block';
                subscriptionStatusDisplay.classList.add('active');
            }
            if (actionsContainer) {
                actionsContainer.style.display = 'none';
            }
            if (subscribeBtn) subscribeBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'block';
        } else {
            // Подписка неактивна
            if (subscriptionStatus) {
                subscriptionStatus.style.display = 'none';
            }
            
            if (profileSubscriptionStatus) {
                profileSubscriptionStatus.style.display = 'none';
            }

            // Обновляем модальное окно
            if (subscriptionStatusDisplay) {
                subscriptionStatusDisplay.style.display = 'none';
            }
            if (actionsContainer) {
                actionsContainer.style.display = 'block';
            }
            if (subscribeBtn) subscribeBtn.style.display = 'block';
            if (cancelBtn) cancelBtn.style.display = 'none';
        }
    }

    // Функция подписки
    async function subscribeBadFox() {
        const userId = localStorage.getItem('userId');
        if (!userId) return;

        const subscribeBtn = document.getElementById('subscribe-btn');
        if (isSubscriptionUpdating || !subscribeBtn) return;

        isSubscriptionUpdating = true;
        subscribeBtn.textContent = 'Подключаем...';
        subscribeBtn.disabled = true;

        try {
            // В реальном приложении здесь был бы запрос к платежной системе
            // const response = await fetch('/api/subscription/subscribe', {...});
            // const result = await response.json();
            
            // Для демо создаем пробную подписку на 3 дня
            const startDate = new Date();
            const expiryDate = new Date(startDate);
            expiryDate.setDate(expiryDate.getDate() + 3); // 3 дня пробного периода

            const subscriptionData = {
                isActive: true,
                startDate: startDate.toISOString(),
                expiryDate: expiryDate.toISOString(),
                type: 'bad_fox',
                trialPeriod: true
            };

            // Сохраняем в localStorage для демо
            localStorage.setItem(`bad_fox_subscription_${userId}`, JSON.stringify(subscriptionData));

            updateSubscriptionUI(subscriptionData);
            
            showToast('Подписка Bad Fox активирована! Первые 3 дня бесплатно.');
            
        } catch (error) {
            console.error('Ошибка подписки:', error);
            showToast('Ошибка активации подписки. Попробуйте еще раз.', 'error');
        } finally {
            isSubscriptionUpdating = false;
            if (subscribeBtn) {
                subscribeBtn.textContent = 'Подключить за 599₽/мес';
                subscribeBtn.disabled = false;
            }
        }
    }

    // Функция отмены подписки
    async function cancelSubscription() {
        const userId = localStorage.getItem('userId');
        if (!userId) return;

        if (!confirm('Вы уверены, что хотите отменить подписку Bad Fox?\n\nПодписка будет действовать до конца оплаченного периода.')) {
            return;
        }

        const cancelBtn = document.getElementById('cancel-subscription-btn');
        if (isSubscriptionUpdating || !cancelBtn) return;

        isSubscriptionUpdating = true;
        cancelBtn.textContent = 'Отменяем...';
        cancelBtn.disabled = true;

        try {
            // В реальном приложении здесь был бы запрос к API для отмены автопродления
            // const response = await fetch('/api/subscription/cancel', {...});
            
            // Для демо просто удаляем подписку из localStorage
            localStorage.removeItem(`bad_fox_subscription_${userId}`);

            updateSubscriptionUI({ isActive: false });
            
            showToast('Подписка отменена. Она будет действовать до конца периода.');
            
        } catch (error) {
            console.error('Ошибка отмены подписки:', error);
            showToast('Ошибка отмены подписки. Попробуйте еще раз.', 'error');
        } finally {
            isSubscriptionUpdating = false;
            if (cancelBtn) {
                cancelBtn.textContent = 'Отменить подписку';
                cancelBtn.disabled = false;
            }
        }
    }

    // Функция показа уведомления
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast-container toast-${type} hidden`;
        toast.innerHTML = `<p class="toast-message">${message}</p>`;
        
        document.body.appendChild(toast);
        
        // Показываем уведомление
        setTimeout(() => toast.classList.remove('hidden'), 100);
        
        // Скрываем через 4 секунды
        setTimeout(() => {
            toast.classList.add('hidden');
            setTimeout(() => document.body.removeChild(toast), 400);
        }, 4000);
    }

    // Инициализация обработчиков подписки
    document.addEventListener('DOMContentLoaded', () => {
        const subscribeBtn = document.getElementById('subscribe-btn');
        const cancelBtn = document.getElementById('cancel-subscription-btn');

        if (subscribeBtn) {
            subscribeBtn.addEventListener('click', subscribeBadFox);
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', cancelSubscription);
        }
    });
    </script>
</body>
</html>
