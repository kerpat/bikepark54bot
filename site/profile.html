<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="config.js"></script>
    <title>–ü—Ä–æ—Ñ–∏–ª—å - Bike App</title>
    <link rel="stylesheet" href="style.css?v=7.3">
    <link rel="stylesheet" href="blend.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–æ—Ñ–∏–ª—è */
        .modal-content .modal-form-group { text-align: left; margin-bottom: 20px; }
        .modal-content .modal-form-group label { display: block; font-size: 0.9rem; font-weight: 600; color: var(--dark-green); margin-bottom: 8px; }
        .modal-content input.form-input { width: 100%; padding: 16px; background-color: var(--card-bg); border: 2px solid var(--card-bg); border-radius: 16px; font-size: 1rem; color: var(--dark-green); font-family: 'Inter', sans-serif; transition: all 0.2s ease; }
        .modal-content input.form-input:focus { outline: none; border-color: var(--icon-green); background-color: var(--white); }
        .input-group-row { display: flex; gap: 15px; }
        .modal-content #add-card-form { margin-top: 20px; }

        .card-preview { background: linear-gradient(45deg, var(--dark-green), #0a5046); color: white; padding: 20px; border-radius: 12px; margin-top: 20px; }
        .card-number { font-family: monospace; font-size: 1.2rem; letter-spacing: 2px; margin-bottom: 15px; }
        .card-details { display: flex; justify-content: space-between; font-size: 0.9rem; opacity: 0.8; }
        .delete-card-btn { background-color: #fcebeb; color: #e53e3e; width: 100%; font-weight: 600; padding: 14px; margin-top: 20px; }

        .error-message { color: #e53e3e; font-size: 0.9rem; text-align: center; margin-top: -10px; margin-bottom: 15px; display: none; }
        .error-message.visible { display: block; }

        .notifications-content { text-align: center; padding: 20px 0; }
        .notifications-content .icon-wrapper { margin: 0 auto 20px auto; background-color: var(--icon-green); }
        .notifications-content p { color: #556f6b; font-size: 1rem; }

        .notification-badge {
            background-color: #e53e3e;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 5px;
        }

        /* === –ù–û–í–´–ï –ò –£–õ–£–ß–®–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ß–ê–¢–ê –ü–û–î–î–ï–†–ñ–ö–ò === */
        .chat-modal .modal-content {
            height: 80vh; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É */
            max-height: 700px;
            display: flex;
            flex-direction: column;
            padding: 0; /* –£–±–∏—Ä–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã, —á—Ç–æ–±—ã —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–∏–ª–µ–≥–∞–ª–∏ –∫ –∫—Ä–∞—è–º */
        }
        .chat-modal h2 {
            padding: 25px 25px 15px 25px; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            flex-shrink: 0;
        }
        .chat-modal .modal-close {
            top: 15px; right: 20px; /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∫—Ä–µ—Å—Ç–∏–∫ */
        }
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 0 20px 20px 20px; /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        }
        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
        }
        .user-message {
            align-self: flex-end;
            background-color: var(--dark-green);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        .support-message {
            align-self: flex-start;
            background-color: var(--card-bg);
            color: var(--dark-green);
            border-bottom-left-radius: 4px;
        }
        .chat-input-area {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-top: 1px solid var(--progress-bar-bg);
            background-color: var(--white);
            flex-shrink: 0;
            position: relative; /* <-- –î–û–ë–ê–í–õ–ï–ù–û –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é */
        }
        .chat-attach-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background-color: var(--card-bg);
            color: var(--dark-green);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: background-color 0.2s ease;
        }
        .chat-attach-btn:hover {
            background-color: var(--progress-bar-bg);
        }
        .chat-attach-btn svg {
            fill: currentColor;
        }
        #chat-input-wrapper {
            flex-grow: 1;
            background-color: var(--card-bg);
            border-radius: 22px;
            display: flex;
            align-items: center;
            padding: 0 5px 0 20px;
        }
        #chat-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            font-size: 1rem;
            color: var(--dark-green);
            outline: none;
        }
        #send-chat-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            flex-shrink: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* === –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ú–ï–ù–Æ –ü–†–ò–ö–†–ï–ü–õ–ï–ù–ò–Ø –§–ê–ô–õ–û–í === */
        #chat-attach-menu {
            position: absolute;
            bottom: 65px; /* –ü–æ–∑–∏—Ü–∏—è –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π */
            left: 15px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 10;
            transform: translateY(10px); /* –ù–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
            opacity: 0;
            visibility: hidden;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        #chat-attach-menu.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .attach-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--dark-green);
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }
        .attach-menu-item:hover {
            background-color: var(--card-bg);
        }
        .attach-menu-item svg {
            width: 20px;
            height: 20px;
            stroke: var(--dark-green);
        }

        /* === –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –í–†–ï–ú–ï–ù–ò –ò –°–¢–ê–¢–£–°–ê –°–û–û–ë–©–ï–ù–ò–ô === */
        .message-meta {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
            float: right;
            clear: both;
        }
        .user-message .message-meta {
            color: #a3e0d2;
        }
        .support-message .message-meta {
            color: #718096;
        }
        .message-status {
            font-weight: bold;
            font-size: 1rem;
            line-height: 1;
        }
        .message-status.read {
            color: var(--primary-green);
        }

        /* === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –§–û–†–ú–´ –ù–ê–°–¢–†–û–ï–ö –û–ü–õ–ê–¢–´ === */
        /* –°–µ–ª–µ–∫—Ç –∏ —Ä–∞–¥–∏–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –æ–ø–ª–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–µ –∂–µ –æ—Ç—Å—Ç—É–ø—ã, —á—Ç–æ –∏ –ø–æ–ª—è –≤–≤–æ–¥–∞ –∫–∞—Ä—Ç—ã */
        .modal-content select.form-input {
            width: 100%;
            padding: 16px;
            background-color: var(--card-bg);
            border: 2px solid var(--card-bg);
            border-radius: 16px;
            font-size: 1rem;
            color: var(--dark-green);
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        .modal-content select.form-input:focus {
            outline: none;
            border-color: var(--icon-green);
            background-color: var(--white);
        }
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤ BikePark54 –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è */
        #BikePark54-tariff-options.hidden {
            display: none;
        }
        /* –†–∞–¥–∏–æ–≥—Ä—É–ø–ø—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ —Ç–∞—Ä–∏—Ñ–æ–≤ */
        .payment-radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .payment-radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-green);
        }
        .BikePark54-tariff-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .BikePark54-tariff-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-green);
        }
    </style>

    <script src="transitions.js" defer></script>
</head>
<body>

<div class="app-screen">
    <div class="app-content">
        <header class="app-header header-centered">
            <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
        </header>
        <main class="app-main profile-main">
            <div class="profile-header">
                <img src="avatar.png" alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="avatar">
                <h2 class="user-name" id="user-name-placeholder">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <p class="user-id">ID: 11071998</p>
                <div id="profile-subscription-status" style="display: none; margin-top: 10px; text-align: left;">
                    <p style="font-size: 0.9rem; color: #556f6b; margin-top: 5px;">–°—Ç–∞—Ç—É—Å: –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ <span id="profile-subscription-expiry">–¥–∞—Ç–∞</span></p>
                </div>
            </div>
            <div class="profile-menu">
                <div class="menu-item" data-modal-target="card-modal" style="cursor: pointer;">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                        <span class="menu-item-text">–ü—Ä–∏–≤—è–∑–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <div class="menu-item" data-modal-target="notifications-modal" style="cursor: pointer;">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <span class="menu-item-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span id="notifications-count" class="notification-badge" style="display: none;">0</span></span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <div class="menu-item" data-modal-target="support-modal" style="cursor: pointer; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                        <span class="menu-item-text">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <!-- –ù–æ–≤—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–ø–ª–∞—Ç—ã -->
                <div class="menu-item" data-modal-target="payment-settings-modal" style="cursor: pointer;">
                    <div class="menu-item-left">
                        <!-- –ò–∫–æ–Ω–∫–∞ –≥–æ—Ä–æ–¥–∞ -->
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        <span class="menu-item-text">–ì–æ—Ä–æ–¥</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <div class="menu-item rewards-menu-item" data-modal-target="rewards-modal" style="cursor: pointer;">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        <span class="menu-item-text">–ú–æ–∏ –Ω–∞–≥—Ä–∞–¥—ã</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <div class="menu-item subscription-menu-item" data-modal-target="subscription-modal" style="cursor: pointer;">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <span class="menu-item-text">–ü–æ–¥–ø–∏—Å–∫–∞ Bad Fox</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <hr class="menu-divider">
                <a href="https://t.me/BikePark54_wello" target="_blank" class="menu-item">
                    <div class="menu-item-left">
                        <svg class="menu-item-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        <span class="menu-item-text">–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</span>
                    </div>
                    <svg class="menu-item-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </a>
            </div>
            <button class="logout-button" id="logout-btn">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </main>
    </div>
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </a>
        <a href="stats.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
        </a>
        <a href="map.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        </a>
        <div class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
    </nav>
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div id="card-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h2 id="card-modal-title">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h2>

        <div id="card-view-container">
            <!-- JS will render content here -->
        </div>
    </div>
</div>
<div id="notifications-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        <div class="notifications-content">
            <div class="icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            </div>
            <div id="notifications-list">
                <p>–£ –≤–∞—Å 0 –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û) -->
<div id="contract-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column;">
        <!-- "–®–∞–ø–∫–∞" –æ–∫–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è -->
        <div style="flex-shrink: 0; padding-bottom: 10px; position: relative;">
             <button class="modal-close">&times;</button>
             <h2>–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ</h2>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
        <div class="modal-body-scroll" style="flex-grow: 1; overflow-y: auto; padding: 0 10px 10px 0;">
            <div id="contract-content"></div>

            <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ -->
            <div id="signature-section" style="text-align: center; margin-top: 20px;">
                <p style="font-weight: 600; color: var(--dark-green); margin-bottom: 10px;">–í–∞—à–∞ –ø–æ–¥–ø–∏—Å—å</p>
                <canvas id="signature-canvas" width="400" height="200" style="border: 1px solid #ccc; border-radius: 8px; max-width: 100%; touch-action: none;"></canvas>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å –æ—Ç—Å—Ç—É–ø–æ–º -->
                <div class="signature-buttons" style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
                    <button id="clear-signature-btn" class="btn btn-secondary">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å—å</button>
                    <button id="sign-contract-btn" class="btn btn-primary">–ü–æ–¥–ø–∏—Å–∞–ª</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô HTML –î–õ–Ø –ß–ê–¢–ê –ü–û–î–î–ï–†–ñ–ö–ò -->
<div id="support-modal" class="modal-overlay hidden chat-modal">
    <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h2>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
        <div class="chat-history" id="chat-history">
            <div class="chat-message support-message">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–∂–µ–º –ø–æ–º–æ—á—å?</div>
        </div>
        <div class="chat-input-area">
            <!-- –ù–û–í–´–ô HTML –î–õ–Ø –ú–ï–ù–Æ -->
            <!-- –°–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ -->
            <input type="file" id="chat-file-input" style="display: none;" multiple>

            <div id="chat-attach-menu">
                <a href="#" class="attach-menu-item" id="attach-photo-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    <span>–§–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ</span>
                </a>
                <a href="#" class="attach-menu-item" id="attach-file-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                    <span>–§–∞–π–ª</span>
                </a>
            </div>

            <button class="chat-attach-btn" id="chat-attach-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- –ó–∞–º–µ–Ω–∏–º –∏–∫–æ–Ω–∫—É –Ω–∞ –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π "–ø–ª—é—Å–∏–∫" –∏–ª–∏ "—Å–∫—Ä–µ–ø–∫—É" -->
                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div id="chat-input-wrapper">
                <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn btn-primary" id="send-chat-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ -->
    <div id="payment-settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>–ì–æ—Ä–æ–¥</h2>
            <form id="payment-settings-form">
                <div class="modal-form-group">
                    <label for="city-select">–ì–æ—Ä–æ–¥</label>
                    <select id="city-select" class="form-input">
                        <option value="–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫" selected>–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–ø–∏—Å–∫–∏ Bad Fox -->
    <div id="subscription-modal" class="modal-overlay hidden">
        <div class="modal-content subscription-modal-content">
            <button class="modal-close">&times;</button>
            <h2 style="color: var(--icon-orange); margin-bottom: 15px;">Bad Fox</h2>
            <div class="subscription-content">
                <div class="subscription-header">
                    <div class="subscription-price">
                        <span class="price-amount">599‚ÇΩ</span>
                        <span class="price-period">/–º–µ—Å—è—Ü</span>
                    </div>
                    <div class="price-yearly">
                        <span class="yearly-price">499‚ÇΩ/–º–µ—Å—è—Ü</span>
                        <span class="yearly-note">–ø—Ä–∏ –≥–æ–¥–æ–≤–æ–π –æ–ø–ª–∞—Ç–µ</span>
                    </div>
                </div>
                
                <div class="subscription-benefits">
                    <h3 style="margin: 20px 0 15px 0; color: var(--dark-text); font-size: 1.1rem;">–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –ø–æ–¥–ø–∏—Å–∫—É:</h3>
                    
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                        <div class="benefit-text">
                            <strong>–°–∫–∏–¥–∫–∞ 10% –Ω–∞ –≤—Å—é –∞—Ä–µ–Ω–¥—É</strong>
                            <p>–≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –∫–∞–∂–¥–æ–π —Å–µ–∫—É–Ω–¥–µ –ø–æ–µ–∑–¥–∫–∏ –Ω–∞ –ª—é–±–æ–º –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ –∏ –∞—Ä–µ–Ω–¥–µ –ª—é–±–æ–π –ê–ö–ë</p>
                        </div>
                    </div>

                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div class="benefit-text">
                            <strong>+25% –±–æ–Ω—É—Å–Ω—ã—Ö –æ—á–∫–æ–≤</strong>
                            <p>–ó–∞ –∫–∞–∂–¥—É—é –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é –∞—Ä–µ–Ω–¥—É, —á–∏—Å—Ç—ã–π –≤–æ–∑–≤—Ä–∞—Ç, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –∏ —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ê–ö–ë</p>
                        </div>
                    </div>

                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                        </div>
                        <div class="benefit-text">
                            <strong>–ì–∏–±–∫–∏–µ —É—Å–ª–æ–≤–∏—è</strong>
                            <p>–ú–æ–∂–µ—Ç–µ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–∞ 1 –¥–µ–Ω—å –∏–ª–∏ –¥–æ–ª—å—à–µ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</p>
                        </div>
                    </div>

                <div class="subscription-trial">
                    <p style="color: var(--icon-orange); font-weight: 600; margin-bottom: 15px;">–ü–µ—Ä–≤—ã–µ 3 –¥–Ω—è ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ!</p>
                    <p style="font-size: 0.85rem; color: #556f6b; margin-bottom: 20px;">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è. –ú–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤ –õ–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.</p>
                </div>

                <div class="subscription-actions" id="subscription-actions">
                    <button class="btn btn-primary" id="subscribe-btn" style="margin-bottom: 15px;">
                        –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∑–∞ 599‚ÇΩ/–º–µ—Å
                    </button>
                    <button class="btn btn-secondary" id="cancel-subscription-btn" style="display: none; color: #e53e3e; border-color: #fcebeb;">
                        –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                    </button>
                </div>

                <div class="subscription-status" id="subscription-status-display" style="display: none; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ea5e9" stroke-width="2">
                            <path d="M9 12l2 2 4-4"/>
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <div>
                            <strong style="color: #0ea5e9;">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #556f6b;">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ <span id="subscription-expiry">–¥–∞—Ç–∞</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–≥—Ä–∞–¥ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
    <div id="rewards-modal" class="modal-overlay hidden">
        <div class="modal-content rewards-modal-content">
            <div class="rewards-modal-header">
                <button class="modal-close">&times;</button>
                <h2 style="color: var(--dark-text); margin-bottom: 15px;">–ú–æ–∏ –Ω–∞–≥—Ä–∞–¥—ã</h2>
            </div>
            <div class="rewards-content">
                <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="rewards-overview">
                    <div class="rewards-stats">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                            </div>
                            <div class="stat-info">
                                <div class="stat-number" id="total-points">2,847</div>
                                <div class="stat-label">–í—Å–µ–≥–æ –æ—á–∫–æ–≤</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon level-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                            </div>
                            <div class="stat-info">
                                <div class="stat-number" id="current-level">–£—Ä–æ–≤–µ–Ω—å 7</div>
                                <div class="stat-label">–ó–≤–µ–∑–¥–Ω—ã–π –∫—É—Ä—å–µ—Ä</div>
                            </div>
                        </div>
                    </div>

                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è -->
                    <div class="level-progress">
                        <div class="progress-info">
                            <span>–î–æ —É—Ä–æ–≤–Ω—è 8</span>
                            <span>1,653 / 2,500 –æ—á–∫–æ–≤</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 66%;"></div>
                        </div>
                    </div>
                </div>

                <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
                <div class="achievements-section">
                    <h3>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                    <div class="achievements-grid">
                        <div class="achievement-item completed">
                            <div class="achievement-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 12l2 2 4-4"/>
                                    <circle cx="12" cy="12" r="10"/>
                                </svg>
                            </div>
                            <div class="achievement-info">
                                <div class="achievement-title">–ü–µ—Ä–≤—ã–µ 10 –ø–æ–µ–∑–¥–æ–∫</div>
                                <div class="achievement-progress">100%</div>
                                <div class="achievement-reward">+150 –æ—á–∫–æ–≤</div>
                            </div>
                            <div class="achievement-badge">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                        </div>

                        <div class="achievement-item in-progress">
                            <div class="achievement-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                            </div>
                            <div class="achievement-info">
                                <div class="achievement-title">–°–µ–∑–æ–Ω–Ω—ã–π –ª–∏–¥–µ—Ä</div>
                                <div class="achievement-progress">42/50 –ø–æ–µ–∑–¥–æ–∫</div>
                                <div class="progress-bar-container mini">
                                    <div class="progress-bar" style="width: 84%;"></div>
                                </div>
                            </div>
                            <div class="achievement-badge">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                        </div>

                        <div class="achievement-item in-progress">
                            <div class="achievement-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </div>
                            <div class="achievement-info">
                                <div class="achievement-title">–ê–∫–∫—É—Ä–∞—Ç–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</div>
                                <div class="achievement-progress">28/30 –¥–Ω–µ–π –±–µ–∑ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π</div>
                                <div class="progress-bar-container mini">
                                    <div class="progress-bar" style="width: 93%;"></div>
                                </div>
                            </div>
                            <div class="achievement-badge">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                        </div>

                        <div class="achievement-item locked">
                            <div class="achievement-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <circle cx="12" cy="16" r="1"/>
                                </svg>
                            </div>
                            <div class="achievement-info">
                                <div class="achievement-title">–ú–∞—Å—Ç–µ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏</div>
                                <div class="achievement-progress">–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ 10</div>
                                <div class="achievement-reward">+500 –æ—á–∫–æ–≤</div>
                            </div>
                            <div class="achievement-badge">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–∏–∑—ã -->
                <div class="rewards-shop-section">
                    <h3>–ú–∞–≥–∞–∑–∏–Ω –ø—Ä–∏–∑–æ–≤</h3>
                    <div class="rewards-grid">
                        <div class="reward-item available">
                            <div class="reward-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 7v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7"/>
                                    <path d="M8 7V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v3"/>
                                    <path d="M3 7h18"/>
                                </svg>
                            </div>
                            <div class="reward-info">
                                <div class="reward-title">–°–∫–∏–¥–∫–∞ 20% –Ω–∞ –∞—Ä–µ–Ω–¥—É</div>
                                <div class="reward-cost">500 –æ—á–∫–æ–≤</div>
                            </div>
                            <button class="btn btn-secondary btn-small">–û–±–º–µ–Ω—è—Ç—å</button>
                        </div>

                        <div class="reward-item available">
                            <div class="reward-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                                    <polyline points="13,2 13,9 20,9"/>
                                </svg>
                            </div>
                            <div class="reward-info">
                                <div class="reward-title">–ü–∞–∫–µ—Ç —Å –Ω–∞–∫–ª–µ–π–∫–∞–º–∏</div>
                                <div class="reward-cost">300 –æ—á–∫–æ–≤</div>
                            </div>
                            <button class="btn btn-secondary btn-small">–û–±–º–µ–Ω—è—Ç—å</button>
                        </div>

                        <div class="reward-item locked">
                            <div class="reward-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M2 12l10-10 10 10-10 10-10-10z"/>
                                    <path d="M12 2v20"/>
                                </svg>
                            </div>
                            <div class="reward-info">
                                <div class="reward-title">–ü—Ä–µ–º–∏—É–º –≤–µ–ª–æ—Å–∏–ø–µ–¥</div>
                                <div class="reward-cost">2000 –æ—á–∫–æ–≤</div>
                                <div class="reward-requirement">–£—Ä–æ–≤–µ–Ω—å 10+</div>
                            </div>
                            <button class="btn btn-secondary btn-small" disabled>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</button>
                        </div>

                        <div class="reward-item available">
                            <div class="reward-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                                </svg>
                            </div>
                            <div class="reward-info">
                                <div class="reward-title">–ë—Ä–µ–Ω–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞</div>
                                <div class="reward-cost">800 –æ—á–∫–æ–≤</div>
                            </div>
                            <button class="btn btn-secondary btn-small">–û–±–º–µ–Ω—è—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é BikePark54 -->
    <div id="main-menu-overlay" class="menu-overlay hidden" role="dialog" aria-modal="true">
        <div class="menu-container">
            <button id="main-menu-close-btn" class="menu-close-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é">&times;</button>
            <div class="menu-items">
                <button class="menu-item-btn primary" id="menu-tariffs-btn">–¢–∞—Ä–∏—Ñ—ã</button>
                <button class="menu-item-btn secondary" id="menu-my-rentals-btn">–ú–æ–∏ –∞—Ä–µ–Ω–¥—ã</button>
                <button class="menu-item-btn secondary" id="menu-topup-btn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                <button class="menu-item-btn secondary" id="menu-map-btn">–ö–∞—Ä—Ç–∞</button>
                <button class="menu-item-btn secondary" id="menu-stats-btn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="menu-item-btn secondary" id="menu-profile-btn">–ü—Ä–æ—Ñ–∏–ª—å</button>
                <button class="menu-item-btn secondary" id="menu-support-btn">–ü–æ–¥–¥–µ—Ä–∂–∫–∞/FAQ</button>
            </div>
        </div>
    </div>

    <div id="card-saved-toast" class="toast-container toast-success hidden"><p class="toast-message">–ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω–∞!</p></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.41.0/dist/umd/supabase.min.js"></script>
        <script>
    const SUPABASE_URL = window.APP_CONFIG.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.APP_CONFIG.SUPABASE_ANON_KEY;
    // We no longer use a global API_BASE_URL for all requests,
    // since they go to different servers.
    // const API_BASE_URL = 'https://serverdogovor.onrender.com';

    // Define a constant specifically for contract requests
    const CONTRACTS_API_URL = window.APP_CONFIG.CONTRACTS_API_URL;

    document.addEventListener('DOMContentLoaded', () => {
        if (window.location.hash === '#support') {
            setTimeout(() => {
                openModal('support-modal');
            }, 300);
        }
        if (window.location.hash === '#card-modal') {
            setTimeout(() => {
                openModal('card-modal');
            }, 300);
        }

        // --- –ù–û–í–´–ô –ö–û–î: –û–±—Ä–∞–±–æ—Ç–∫–∞ deeplink –∏–∑ Telegram ---
        try {
            const tg = window.Telegram.WebApp;
            tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `start_param`
            if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
                const startParam = tg.initDataUnsafe.start_param;

                // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä —Ä–∞–≤–µ–Ω 'notifications', –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                if (startParam === 'notifications') {
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã UI —É—Å–ø–µ–ª –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å—Å—è
                    setTimeout(() => {
                        openModal('notifications-modal');
                    }, 300); // 300 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
                }
            }
        } catch (error) {
            console.log("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:", error);
        }
        // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ---
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- –û–ë–©–ê–Ø –õ–û–ì–ò–ö–ê –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù ---
        const modalTriggers = document.querySelectorAll('[data-modal-target]');
        const modals = document.querySelectorAll('.modal-overlay');
        const modalCloses = document.querySelectorAll('.modal-close');

        // Ensure modals are attached directly to body to avoid stacking issues
        [...modals].forEach(modal => {
            if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
            }
        });

        const openModal = (modalId) => {
            console.log('Trying to open modal:', modalId);
            const modal = document.getElementById(modalId);
            
            if (!modal) {
                console.error('‚ùå Modal not found:', modalId);
                console.log('Available modals:', Array.from(document.querySelectorAll('.modal-overlay')).map(m => m.id));
                return;
            }

            console.log('‚úÖ Modal found:', modalId);
            console.log('Modal element:', modal);
            console.log('Modal classes before:', modal.className);
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∏–º
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.zIndex = '1000';
            
            if (modalId === 'card-modal') updateCardView();
            if (modalId === 'payment-settings-modal') updatePaymentSettingsView();
            if (modalId === 'notifications-modal') loadNotifications();
            if (modalId === 'rewards-modal') {
                console.log('Initializing rewards...');
                initializeRewards();
            }
            if (modalId === 'subscription-modal') {
                loadSubscriptionStatus();
                initSubscriptionHandlers();
            }
            if (modalId === 'support-modal') initializeSupportChat();

            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å hidden –∏ –¥–æ–±–∞–≤–ª—è–µ–º —è–≤–Ω—ã–µ —Å—Ç–∏–ª–∏
            modal.classList.remove('hidden');
            modal.classList.add('visible');
            
            console.log('Modal classes after:', modal.className);
            console.log('Modal display style:', modal.style.display);
        };

        const closeModal = (modal) => {
            if (modal) {
                console.log('Closing modal:', modal.id);
                modal.classList.add('hidden');
                modal.classList.remove('visible');
                modal.style.display = 'none';
            }
        };

        modalTriggers.forEach(trigger => trigger.addEventListener('click', (e) => {
            e.preventDefault();
            const target = trigger.dataset.modalTarget;
            const triggerText = trigger.querySelector('.menu-item-text')?.textContent || '–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞';
            console.log('üéØ Modal trigger clicked:', target);
            console.log('üéØ Trigger text:', triggerText);
            console.log('üéØ Trigger element:', trigger);
            openModal(target);
        }));
        modalCloses.forEach(button => button.addEventListener('click', () => closeModal(button.closest('.modal-overlay'))));
        modals.forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); }));

        // –¢–µ—Å—Ç–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        console.log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù ===');
        console.log('Modal triggers found:', modalTriggers.length);
        console.log('All modal triggers:', modalTriggers);
        console.log('Rewards modal exists:', !!document.getElementById('rewards-modal'));
        console.log('Rewards modal element:', document.getElementById('rewards-modal'));
        const rewardsItem = document.querySelector('[data-modal-target="rewards-modal"]');
        console.log('Rewards menu item:', rewardsItem);
        
        // –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        if (rewardsItem) {
            console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ "–ú–æ–∏ –Ω–∞–≥—Ä–∞–¥—ã" –Ω–∞–π–¥–µ–Ω–∞');
            console.log('Element details:', {
                tagName: rewardsItem.tagName,
                className: rewardsItem.className,
                dataset: rewardsItem.dataset
            });
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è
            console.log('Event listeners:', getEventListeners ? getEventListeners(rewardsItem) : 'Event listener detection not available');
        } else {
            console.log('‚ùå –ö–Ω–æ–ø–∫–∞ "–ú–æ–∏ –Ω–∞–≥—Ä–∞–¥—ã" –ù–ï –ù–ê–ô–î–ï–ù–ê');
            // –ò—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
            const alternative1 = document.querySelector('.rewards-menu-item');
            const alternative2 = document.querySelector('.menu-item:last-child');
            console.log('Alternative searches:', { alternative1, alternative2 });
        }
        
        console.log('=== –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===');

        // --- –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ò –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
        const isRegistered = localStorage.getItem('isRegistered') === 'true';
        const registrationType = localStorage.getItem('registrationType');
        
        if (!isRegistered) {
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
            if (window.Telegram?.WebApp?.initData) {
                window.location.replace('start.html');
            } else {
                window.location.replace('browser-login.html');
            }
            return;
        }

        const userName = localStorage.getItem('userName');
        if (userName) document.getElementById('user-name-placeholder').textContent = userName;
        const userId = localStorage.getItem('userId');
        if (userId) document.querySelector('.user-id').textContent = `ID: ${userId.slice(-8)}`;
        
        // --- TOAST –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ö–ê–†–¢–ï ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('card_saved') === 'true') {
            const toast = document.getElementById('card-saved-toast');
            if(toast) {
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            }
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- –õ–û–ì–ò–ö–ê –ö–ù–û–ü–ö–ò –í–´–•–û–î–ê ---
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
                    const registrationType = localStorage.getItem('registrationType');
                    
                    // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
                    const keysToRemove = [
                        'isRegistered', 'userId', 'userName', 
                        'userFirstName', 'userLastName', 'userPhone',
                        'registrationType', 'registrationDate'
                    ];
                    
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    if (registrationType === 'browser') {
                        window.location.replace('browser-login.html');
                    } else {
                        window.location.replace('start.html');
                    }
                }
            });
        }
        
        // ===============================================================
        // === –ù–ê–ß–ê–õ–û –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê: –ü–†–ò–í–Ø–ó–ê–ù–ù–ê–Ø –ö–ê–†–¢–ê =========
        // ===============================================================
        const cardViewContainer = document.getElementById('card-view-container');

        const handleAddCardClick = async () => {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                return;
            }
            const btn = document.getElementById('add-card-btn');
            if(btn) {
                btn.disabled = true;
                btn.textContent = '–°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É...';
            }
            
            try {
                // –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à API-—ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.
                const response = await fetch(`/api/payments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save-card', userId: userId })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                
                if (data.confirmation_url) {
                    window.location.href = data.confirmation_url;
                } else {
                    throw new Error('–ù–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫–∞—Ä—Ç—ã.');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É';
                }
            }
        };

        const handleUnbindClick = async () => {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                return;
            }
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–≤—è–∑–∞—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã?')) {
                return;
            }
            const btn = document.getElementById('unbind-card-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = '–û—Ç–≤—è–∑—ã–≤–∞–µ–º...';
            }
            try {
                // –õ–æ–≥–∏–∫–∞ –æ—Ç–≤—è–∑–∫–∏ —á–µ—Ä–µ–∑ –≤–∞—à API
                const response = await fetch(`/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'unbind-payment-method', userId: userId })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–≤—è–∑–∞—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
                }
                alert('–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤—è–∑–∞–Ω.');
                updateCardView();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É';
                }
            }
        };
        
        let isUpdatingCardView = false;
        const updateCardView = async () => {
            if (isUpdatingCardView) return;
            isUpdatingCardView = true;

            const userId = localStorage.getItem('userId');
            if (!userId || !cardViewContainer) {
                isUpdatingCardView = false;
                return;
            }
            
            try {
                // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API ---
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-payment-method', userId: userId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to get payment method');

                const paymentMethod = result.payment_method;
                if (!paymentMethod) throw new Error('No saved method');

                let cardTitle = '';
                let cardSubtitle = '';
                if (paymentMethod.type === 'bank_card' && paymentMethod.card) {
                    cardTitle = `**** **** **** ${paymentMethod.card.last4}`;
                    cardSubtitle = `${paymentMethod.card.card_type || '–ö–∞—Ä—Ç–∞'}`;
                } else if (paymentMethod.type === 'sbp') {
                    cardTitle = '–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π';
                    cardSubtitle = '–ü—Ä–∏–≤—è–∑–∞–Ω —Å—á—ë—Ç –°–ë–ü';
                } else {
                    cardTitle = paymentMethod.display_name || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥';
                    cardSubtitle = '–ö–∞—Ä—Ç–∞ –¥–ª—è –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–π';
                }

                cardViewContainer.innerHTML = `
                    <div id="card-display-view">
                        <div class="card-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px;">
                            <div class="card-number" style="font-size: 18px; font-weight: 600; margin-bottom: 8px; letter-spacing: 2px;">${cardTitle}</div>
                            <div class="card-details" style="display: flex; justify-content: space-between; font-size: 14px; opacity: 0.95;">
                                <span>${cardSubtitle}</span>
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px;">–ü—Ä–∏–≤—è–∑–∞–Ω–∞</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="unbind-card-btn" style="margin-top: 20px;">–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É</button>
                    </div>`;
                document.getElementById('unbind-card-btn').addEventListener('click', handleUnbindClick);

            } catch (error) {
                cardViewContainer.innerHTML = `
                    <div id="card-form-view">
                        <p style="margin-bottom: 20px; color: var(--dark-green);">
                            –£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–≤—è–∑–∞—Ç—å –µ–µ —Å–µ–π—á–∞—Å –∏–ª–∏ –æ–Ω–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.
                        </p>
                        <button class="btn btn-primary" id="add-card-btn" style="width: 100%;">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É</button>
                    </div>`;
                document.getElementById('add-card-btn').addEventListener('click', handleAddCardClick);
            } finally {
                isUpdatingCardView = false;
            }
        };
        // ===============================================================
        // === –ö–û–ù–ï–¶ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê: –ü–†–ò–í–Ø–ó–ê–ù–ù–ê–Ø –ö–ê–†–¢–ê =========
        // ===============================================================


        // --- –í–ê–®–ê –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ò –ü–û–î–ü–ò–°–ê–ù–ò–Ø ---
        async function updateNotificationsCount() {
            const userId = localStorage.getItem('userId');
            if (!userId) return;
            try {
                const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-pending-contracts', userId: userId })
                });
                const result = await response.json();
                if (!response.ok) return;

                const notifications = result.notifications || [];
                const countEl = document.getElementById('notifications-count');
                if (notifications.length > 0) {
                    countEl.textContent = notifications.length;
                    countEl.style.display = 'inline';
                } else {
                    countEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating notifications count:', error);
            }
        }
        
        async function loadNotifications() {
            const userId = localStorage.getItem('userId');
            if (!userId) return;

            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...</p>';

            try {
                const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-pending-contracts', userId: userId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Server error');
                
                const notifications = result.notifications || [];
                const countEl = document.getElementById('notifications-count');

                if (notifications.length > 0) {
                    countEl.textContent = notifications.length;
                    countEl.style.display = 'inline';
                    notificationsList.innerHTML = '';
                    notifications.forEach(item => {
                        const notification = document.createElement('div');
                        notification.className = 'notification-item'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º div –¥–ª—è –ª—É—á—à–µ–π —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
                        if (item.status === 'awaiting_contract_signing') {
                            notification.innerHTML = `
                                <p>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä –¥–ª—è –∞—Ä–µ–Ω–¥—ã –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞.</p>
                                <button class="btn btn-primary sign-initial-contract-btn" data-rental-id="${item.id}" style="margin-top: 10px;">–ü–æ–¥–ø–∏—Å–∞—Ç—å</button>
                            `;
                        } else if (item.status === 'awaiting_return_signature') {
                            notification.innerHTML = `
                                <p>–ê–∫—Ç —Å–¥–∞—á–∏-–ø—Ä–∏–µ–º–∫–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≥–æ—Ç–æ–≤ –∫ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—é.</p>
                                <button class="btn btn-primary sign-return-act-btn" data-rental-id="${item.id}" style="margin-top: 10px;">–ü–æ–¥–ø–∏—Å–∞—Ç—å –ê–∫—Ç</button>
                            `;
                        }
                        notificationsList.appendChild(notification);
                    });
                } else {
                    countEl.style.display = 'none';
                    notificationsList.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>';
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                notificationsList.innerHTML = `<p style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>`;
            }
        }

        document.addEventListener('click', async (e) => {
            if (e.target.matches('.sign-initial-contract-btn')) {
                openContractModal(e.target.dataset.rentalId);
            }
            if (e.target.matches('.sign-return-act-btn')) {
                openReturnActModal(e.target.dataset.rentalId);
            }
            if (e.target.matches('#contract-modal .modal-close')) {
                document.getElementById('contract-modal').classList.add('hidden');
            }
        });

        async function openContractModal(rentalId) {
            try {
                const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-contract-details', userId, rentalId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Server error');
                
                document.getElementById('contract-content').innerHTML = generateContractHTML(result.rental);
                document.getElementById('contract-modal').classList.remove('hidden');
                setupSignatureCanvas(rentalId, 'confirm-contract');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–≥–æ–≤–æ—Ä–∞: ' + error.message);
            }
        }

        async function openReturnActModal(rentalId) {
            try {
                const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-contract-details', userId, rentalId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Server error');

                const defects = result.rental.extra_data?.defects || [];
                document.getElementById('contract-content').innerHTML = generateReturnActHTML(result.rental, defects);
                document.getElementById('contract-modal').classList.remove('hidden');
                setupSignatureCanvas(rentalId, 'confirm-return-act');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∞ —Å–¥–∞—á–∏: ' + error.message);
            }
        }

        function setupSignatureCanvas(rentalId, action) {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            let drawing = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const startDrawing = (e) => { e.preventDefault(); drawing = true; const { x, y } = getCoords(e); ctx.beginPath(); ctx.moveTo(x, y); };
            const draw = (e) => { if (!drawing) return; e.preventDefault(); const { x, y } = getCoords(e); ctx.lineTo(x, y); ctx.stroke(); };
            const stopDrawing = () => { drawing = false; };
            const getCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : e;
                return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
            };

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            const clearBtn = document.getElementById('clear-signature-btn');
            const signBtn = document.getElementById('sign-contract-btn');
            const newClearBtn = clearBtn.cloneNode(true);
            const newSignBtn = signBtn.cloneNode(true);
            newSignBtn.textContent = '–ü–æ–¥–ø–∏—Å–∞–ª'; // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
            clearBtn.parentNode.replaceChild(newClearBtn, clearBtn);
            signBtn.parentNode.replaceChild(newSignBtn, signBtn);

            newClearBtn.addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));

            newSignBtn.addEventListener('click', async () => {
                if (ctx.getImageData(0, 0, canvas.width, canvas.height).data.some(p => p !== 0)) {
                    const signatureData = canvas.toDataURL('image/png');
                    try {
                        const response = await fetch(`${CONTRACTS_API_URL}/api/user`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action, userId, rentalId, signatureData })
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error || 'Server error');
                        alert(action === 'confirm-contract' ? '–î–æ–≥–æ–≤–æ—Ä –ø–æ–¥–ø–∏—Å–∞–Ω!' : '–ê–∫—Ç —Å–¥–∞—á–∏ –ø–æ–¥–ø–∏—Å–∞–Ω!');
                        document.getElementById('contract-modal').classList.add('hidden');
                        window.location.reload();
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è: ' + error.message);
                    }
                } else {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à—É –ø–æ–¥–ø–∏—Å—å.');
                }
            });
        }

        function generateContractHTML(rental) {
            const client = rental.clients;
            const bike = rental.bikes;
            const now = new Date();

            let passport = {}; // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

            // --- –≠–¢–û –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ---
            if (client?.recognized_passport_data) {
                const passportData = client.recognized_passport_data;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ –æ–±—ä–µ–∫—Ç, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ.
                // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, —Ç–æ–≥–¥–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–∞—Ä—Å–∏—Ç—å.
                if (typeof passportData === 'object' && passportData !== null) {
                    passport = passportData; // –î–∞–Ω–Ω—ã–µ —É–∂–µ —è–≤–ª—è—é—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º
                } else if (typeof passportData === 'string') {
                    try {
                        passport = JSON.parse(passportData); // –î–∞–Ω–Ω—ã–µ - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, –ø–∞—Ä—Å–∏–º –µ–µ
                    } catch (e) {
                        console.error("Failed to parse passport data string:", e);
                        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞, passport –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø—É—Å—Ç—ã–º
                    }
                }
            }
            // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

            const passportNumber = (passport.series || passport.number)
                ? `${passport.series || ''} ${passport.number || ''}`.trim()
                : 'N/A';

            const batteryNumbers = Array.isArray(bike?.battery_numbers) ? bike.battery_numbers.join(', ') : (bike?.battery_numbers || 'N/A');

            return `
                <div style="text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 20px;">
                    –ê–∫—Ç –ø—Ä–∏–µ–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏<br>
                    (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Ññ1 –∫ –î–æ–≥–æ–≤–æ—Ä—É –ø—Ä–æ–∫–∞—Ç–∞)
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.9em;">
                    <span>–≥. ${client?.city || '–ú–æ—Å–∫–≤–∞'}</span>
                    <span>${now.toLocaleDateString('ru-RU')}</span>
                </div>
                <h4 style="margin-top: 20px; margin-bottom: 10px;">1. –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h4>
                <table border="1" style="width:100%; border-collapse: collapse; margin-bottom: 20px; text-align: left; font-size: 0.9em;">
                    <tbody style="text-align: left;">
                        <tr><th style="padding: 8px; width: 40%;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><td style="padding: 8px;">${bike?.model_name || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–ù–æ–º–µ—Ä —Ä–∞–º—ã</th><td style="padding: 8px;">${bike?.frame_number || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–ù–æ–º–µ—Ä–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–æ–≤</th><td style="padding: 8px;">${batteryNumbers}</td></tr>
                        <tr><th style="padding: 8px;">–†–µ–≥. –Ω–æ–º–µ—Ä</th><td style="padding: 8px;">${bike?.registration_number || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–ù–æ–º–µ—Ä IOT</th><td style="padding: 8px;">${bike?.iot_device_id || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–î–æ–ø. –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th><td style="padding: 8px;">${bike?.additional_equipment || 'N/A'}</td></tr>
                    </tbody>
                </table>
                <h4 style="margin-top: 20px; margin-bottom: 10px;">2. –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä</h4>
                <table border="1" style="width:100%; border-collapse: collapse; margin-bottom: 20px; text-align: left; font-size: 0.9em;">
                    <tbody style="text-align: left;">
                        <tr><th style="padding: 8px; width: 40%;">–§–ò–û</th><td style="padding: 8px;">${client?.name || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th><td style="padding: 8px;">${passport.birth_date || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–ü–∞—Å–ø–æ—Ä—Ç</th><td style="padding: 8px;">${passportNumber}</td></tr>
                        <tr><th style="padding: 8px;">–ö–µ–º –≤—ã–¥–∞–Ω</th><td style="padding: 8px;">${passport.issuing_authority || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th><td style="padding: 8px;">${passport.issue_date || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th><td style="padding: 8px;">${passport.registration_address || 'N/A'}</td></tr>
                    </tbody>
                </table>
                <p style="font-size: 0.9em; margin-top: 20px;">–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂ –ø—Ä–æ–π–¥–µ–Ω, —Å —É—Å–ª–æ–≤–∏—è–º–∏ —Å–æ–≥–ª–∞—Å–µ–Ω, —Ç–µ—Ö–Ω–∏–∫–∞ –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Ç–Ω—ã, –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∏—Å–ø—Ä–∞–≤–Ω—ã, –Ω–∞—Ä–µ–∫–∞–Ω–∏–π –Ω–µ—Ç.</p>
            `;
        }

        function generateReturnActHTML(rental, defects) {
            const client = rental.clients;
            const bike = rental.bikes;
            const now = new Date();
            const batteryNumbers = Array.isArray(bike?.battery_numbers) ? bike.battery_numbers.join(', ') : (bike?.battery_numbers || 'N/A');
            const defectsHTML = defects && defects.length > 0 
                ? `<h4 style="margin-top: 20px; margin-bottom: 10px;">–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏</h4><ul style="padding-left: 20px; margin-bottom: 20px; font-size: 0.9em;">${defects.map(d => `<li>${d}</li>`).join('')}</ul>`
                : '<p style="font-size: 0.9em; margin-top: 20px;">–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–¥–∞—á–∏ –Ω–µ –≤—ã—è–≤–ª–µ–Ω—ã.</p>';

            return `
                <div style="text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 20px;">
                    –ê–∫—Ç –ø—Ä–∏–µ–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏ (–≤–æ–∑–≤—Ä–∞—Ç–∞)<br>
                    (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Ññ2 –∫ –î–æ–≥–æ–≤–æ—Ä—É –ø—Ä–æ–∫–∞—Ç–∞)
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.9em;">
                    <span>–≥. ${client?.city || '–ú–æ—Å–∫–≤–∞'}</span>
                    <span>${now.toLocaleDateString('ru-RU')}</span>
                </div>
                <h4 style="margin-top: 20px; margin-bottom: 10px;">1. –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h4>
                <table border="1" style="width:100%; border-collapse: collapse; margin-bottom: 20px; text-align: left; font-size: 0.9em;">
                    <tbody>
                        <tr><th style="padding: 8px; width: 40%;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><td style="padding: 8px;">${bike?.model_name || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–ù–æ–º–µ—Ä —Ä–∞–º—ã</th><td style="padding: 8px;">${bike?.frame_number || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–ù–æ–º–µ—Ä–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–æ–≤</th><td style="padding: 8px;">${batteryNumbers}</td></tr>
                        <tr><th style="padding: 8px;">–†–µ–≥. –Ω–æ–º–µ—Ä</th><td style="padding: 8px;">${bike?.registration_number || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–ù–æ–º–µ—Ä IOT</th><td style="padding: 8px;">${bike?.iot_device_id || 'N/A'}</td></tr>
                        <tr><th style="padding: 8px;">–î–æ–ø. –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th><td style="padding: 8px;">${bike?.additional_equipment || 'N/A'}</td></tr>
                    </tbody>
                </table>
                ${defectsHTML}
                <p style="font-size: 0.9em; margin-top: 20px;">–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä —Ç–µ—Ö–Ω–∏–∫—É –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–ª. –ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å —Ç–µ—Ö–Ω–∏–∫—É –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–∏–ª. –ü—Ä–µ—Ç–µ–Ω–∑–∏–π —Å—Ç–æ—Ä–æ–Ω—ã –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É –Ω–µ –∏–º–µ—é—Ç.</p>
            `;
        }

        // ===============================================================
        // === –ù–ê–ß–ê–õ–û –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê: –ß–ê–¢ –ü–û–î–î–ï–†–ñ–ö–ò =============
        // ===============================================================
        const supportModal = document.getElementById('support-modal');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatAttachBtn = document.getElementById('chat-attach-btn');
        const chatAttachMenu = document.getElementById('chat-attach-menu');
        const chatFileInput = document.getElementById('chat-file-input');
        const attachPhotoBtn = document.getElementById('attach-photo-btn');
        const attachFileBtn = document.getElementById('attach-file-btn');

        let currentChatSubscription = null;
        let anonymousChatId = localStorage.getItem('anonymousChatId');
        if (!anonymousChatId) {
            anonymousChatId = `anon_${self.crypto.randomUUID()}`;
            localStorage.setItem('anonymousChatId', anonymousChatId);
        }

        function initializeSupportChat() {
            loadChatHistory();
            subscribeToChat();
        }
    
        const addChatMessage = (message) => {
            const senderClass = message.sender === 'user' ? 'user-message' : 'support-message';
            const messageEl = document.createElement('div');
            messageEl.dataset.messageId = message.id;
            messageEl.classList.add('chat-message', senderClass);

            const time = new Date(message.created_at || Date.now()).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            let contentHTML = '';
            if (message.file_url) {
                if (message.file_type && message.file_type.startsWith('image/')) {
                    contentHTML = `<img src="${message.file_url}" style="max-width: 100%; border-radius: 12px; cursor: pointer;" onclick="window.open('${message.file_url}', '_blank')">`;
                } else {
                    contentHTML = `<a href="${message.file_url}" target="_blank" style="color: inherit; text-decoration: underline;">–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: ${message.message_text || '—Ñ–∞–π–ª'}</a>`;
                }
            } else {
                contentHTML = message.message_text;
            }

            const statusClass = message.is_read ? 'read' : '';
            const statusCheckmarks = message.is_read ? '‚úì‚úì' : '‚úì';
            const statusHTML = message.sender === 'user' ? `<span class="message-status ${statusClass}">${statusCheckmarks}</span>` : '';

            messageEl.innerHTML = `
                <div>${contentHTML}</div>
                <div class="message-meta">
                    <span class="message-time">${time}</span>
                    ${statusHTML}
                </div>`;

            chatHistory.appendChild(messageEl);
            chatHistory.scrollTo({ top: chatHistory.scrollHeight, behavior: 'smooth' });
        };

        async function loadChatHistory() {
            chatHistory.innerHTML = '<p style="text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
            const userId = localStorage.getItem('userId');
            const filterField = userId ? 'client_id' : 'anonymous_chat_id';
            const filterValue = userId || anonymousChatId;
            
            await supabase.from('support_messages').update({ is_read: true }).eq(filterField, filterValue).eq('sender', 'admin').eq('is_read', false);
            const { data, error } = await supabase.from('support_messages').select('*').eq(filterField, filterValue).order('created_at');

            chatHistory.innerHTML = '';
            if (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞:", error);
                chatHistory.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.';
                return;
            }
            data.forEach(addChatMessage);
        }

        const sendMessage = async (text, file = null) => {
            const userId = localStorage.getItem('userId');
            let fileUrl = null, fileType = null;
            let messageText = text;

            if (file) {
                const filePath = `${userId || anonymousChatId}/${Date.now()}_${file.name}`;
                const { error: uploadError } = await supabase.storage.from('support_files').upload(filePath, file);
                if (uploadError) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: ' + uploadError.message); return; }
                const { data: urlData } = supabase.storage.from('support_files').getPublicUrl(filePath);
                fileUrl = urlData.publicUrl;
                fileType = file.type;
                if (!messageText) messageText = file.name;
            }

            if (!messageText) return;

            const payload = {
                id: self.crypto.randomUUID(),
                sender: 'user', message_text: messageText, file_url: fileUrl, file_type: fileType,
                client_id: userId, anonymous_chat_id: !userId ? anonymousChatId : null,
                created_at: new Date().toISOString(), is_read: false
            };

            addChatMessage(payload); 
            chatInput.value = '';

            const { error } = await supabase.from('support_messages').insert(payload);
            if (error) alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + error.message);
        };

        function subscribeToChat() {
            if (currentChatSubscription) supabase.removeChannel(currentChatSubscription);

            const userId = localStorage.getItem('userId');
            const filter = userId ? `client_id=eq.${userId}` : `anonymous_chat_id=eq.${anonymousChatId}`;

            currentChatSubscription = supabase.channel(`support-chat-${userId || anonymousChatId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'support_messages', filter }, (payload) => {
                    if (payload.new.sender === 'admin') addChatMessage(payload.new);
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'support_messages', filter }, (payload) => {
                    if (payload.new.sender === 'user' && payload.new.is_read) {
                        const messageEl = chatHistory.querySelector(`[data-message-id='${payload.new.id}']`);
                        const statusEl = messageEl?.querySelector('.message-status');
                        if (statusEl) {
                            statusEl.textContent = '‚úì‚úì';
                            statusEl.classList.add('read');
                        }
                    }
                })
                .subscribe();
        }

        sendChatBtn.addEventListener('click', () => sendMessage(chatInput.value.trim()));
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(chatInput.value.trim()); } });
        chatAttachBtn.addEventListener('click', (e) => { e.stopPropagation(); chatAttachMenu.classList.toggle('visible'); });
        document.addEventListener('click', (e) => { if (!chatAttachBtn.contains(e.target) && !chatAttachMenu.contains(e.target)) chatAttachMenu.classList.remove('visible'); });
        attachPhotoBtn.addEventListener('click', () => { chatFileInput.accept = "image/*,video/*"; chatFileInput.click(); });
        attachFileBtn.addEventListener('click', () => { chatFileInput.accept = "*/*"; chatFileInput.click(); });
        chatFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) sendMessage(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞: ${file.name}...`, file); chatAttachMenu.classList.remove('visible'); e.target.value = null; });
        // ===============================================================
        // === –ö–û–ù–ï–¶ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê: –ß–ê–¢ –ü–û–î–î–ï–†–ñ–ö–ò ===============
        // ===============================================================


        // ===============================================================
        // === –ù–ê–ß–ê–õ–û –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê: –ù–ê–°–¢–†–û–ô–ö–ò –û–ü–õ–ê–¢–´ ==========
        // ===============================================================
        const citySelect = document.getElementById('city-select');
        const providerRadios = document.querySelectorAll('input[name="provider"]');
        const paymentSettingsForm = document.getElementById('payment-settings-form');

        function updatePaymentSettingsView() {
            const savedCity = localStorage.getItem('selectedCity');
            if (savedCity && citySelect) citySelect.value = savedCity;
            
            const savedProvider = localStorage.getItem('paymentProvider') || 'BikePark54';
            if (providerRadios) providerRadios.forEach(r => { r.checked = (r.value === savedProvider); });
        }

        if (paymentSettingsForm) {
            paymentSettingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedCity = citySelect.value;
                const provider = document.querySelector('input[name="provider"]:checked').value;
                
                localStorage.setItem('selectedCity', selectedCity);
                localStorage.setItem('paymentProvider', provider);
                localStorage.removeItem('BikePark54Tariff'); 
                
                closeModal(document.getElementById('payment-settings-modal'));
            });
        }
        // ===============================================================
        // === –ö–û–ù–ï–¶ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê: –ù–ê–°–¢–†–û–ô–ö–ò –û–ü–õ–ê–¢–´ ============
        // ===============================================================


        // –ü–µ—Ä–≤–∏—á–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateNotificationsCount();
        loadSubscriptionStatus();
        loadRewardsData();
    });

    // === –°–ò–°–¢–ï–ú–ê –ù–ê–ì–†–ê–î –ò –î–û–°–¢–ò–ñ–ï–ù–ò–ô ===

    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–≥—Ä–∞–¥
    function initializeRewards() {
        updateRewardsData();
        bindRewardsEvents();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥
    function loadRewardsData() {
        const userId = localStorage.getItem('userId');
        if (!userId) return;

        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ API
        // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
        const rewardsData = getDemoRewardsData();
        saveRewardsData(rewardsData);
        updateRewardsUI(rewardsData);
    }

    // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥
    function getDemoRewardsData() {
        return {
            totalPoints: 2847,
            currentLevel: 7,
            levelName: "–ó–≤–µ–∑–¥–Ω—ã–π –∫—É—Ä—å–µ—Ä",
            pointsToNext: 1653,
            pointsNeeded: 2500,
            achievements: [
                {
                    id: 1,
                    title: "–ü–µ—Ä–≤—ã–µ 10 –ø–æ–µ–∑–¥–æ–∫",
                    progress: 100,
                    maxProgress: 100,
                    reward: 150,
                    status: "completed"
                },
                {
                    id: 2,
                    title: "–°–µ–∑–æ–Ω–Ω—ã–π –ª–∏–¥–µ—Ä",
                    progress: 42,
                    maxProgress: 50,
                    status: "in-progress"
                },
                {
                    id: 3,
                    title: "–ê–∫–∫—É—Ä–∞—Ç–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å",
                    progress: 28,
                    maxProgress: 30,
                    status: "in-progress"
                },
                {
                    id: 4,
                    title: "–ú–∞—Å—Ç–µ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏",
                    progress: 0,
                    maxProgress: 100,
                    reward: 500,
                    status: "locked",
                    requirement: "–£—Ä–æ–≤–µ–Ω—å 10+"
                }
            ],
            rewards: [
                {
                    id: 1,
                    title: "–°–∫–∏–¥–∫–∞ 20% –Ω–∞ –∞—Ä–µ–Ω–¥—É",
                    cost: 500,
                    status: "available"
                },
                {
                    id: 2,
                    title: "–ü–∞–∫–µ—Ç —Å –Ω–∞–∫–ª–µ–π–∫–∞–º–∏",
                    cost: 300,
                    status: "available"
                },
                {
                    id: 3,
                    title: "–ü—Ä–µ–º–∏—É–º –≤–µ–ª–æ—Å–∏–ø–µ–¥",
                    cost: 2000,
                    status: "locked",
                    requirement: "–£—Ä–æ–≤–µ–Ω—å 10+"
                },
                {
                    id: 4,
                    title: "–ë—Ä–µ–Ω–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞",
                    cost: 800,
                    status: "available"
                }
            ]
        };
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥
    function saveRewardsData(data) {
        const userId = localStorage.getItem('userId');
        if (userId) {
            localStorage.setItem(`rewards_data_${userId}`, JSON.stringify(data));
        }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥
    function getSavedRewardsData() {
        const userId = localStorage.getItem('userId');
        if (userId) {
            const saved = localStorage.getItem(`rewards_data_${userId}`);
            if (saved) {
                return JSON.parse(saved);
            }
        }
        return getDemoRewardsData();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –Ω–∞–≥—Ä–∞–¥
    function updateRewardsUI(data) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('total-points').textContent = data.totalPoints.toLocaleString();
        document.getElementById('current-level').textContent = `–£—Ä–æ–≤–µ–Ω—å ${data.currentLevel}`;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —É—Ä–æ–≤–Ω—è
        const progressElement = document.querySelector('.level-progress .progress-bar');
        if (progressElement) {
            const progress = (data.pointsToNext / data.pointsNeeded) * 100;
            progressElement.style.width = `${progress}%`;
            
            const progressText = document.querySelector('.level-progress .progress-info');
            if (progressText) {
                progressText.innerHTML = `
                    <span>–î–æ —É—Ä–æ–≤–Ω—è ${data.currentLevel + 1}</span>
                    <span>${data.pointsToNext.toLocaleString()} / ${data.pointsNeeded.toLocaleString()} –æ—á–∫–æ–≤</span>
                `;
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        updateAchievementsUI(data.achievements);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–∑—ã
        updateRewardsShopUI(data.rewards);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    function updateAchievementsUI(achievements) {
        // –≠—Ç–æ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ HTML
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –º–∞–≥–∞–∑–∏–Ω–∞ –ø—Ä–∏–∑–æ–≤
    function updateRewardsShopUI(rewards) {
        // –≠—Ç–æ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ HTML
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–æ–≤
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥
    function updateRewardsData() {
        const data = getSavedRewardsData();
        updateRewardsUI(data);
    }

    // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–∞–≥—Ä–∞–¥
    function bindRewardsEvents() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–º–µ–Ω–∞ –ø—Ä–∏–∑–æ–≤
        const exchangeButtons = document.querySelectorAll('.reward-item.available .btn-small');
        exchangeButtons.forEach(button => {
            button.addEventListener('click', handleRewardExchange);
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–º–µ–Ω–∞ –ø—Ä–∏–∑–∞
    function handleRewardExchange(event) {
        const button = event.target;
        const rewardItem = button.closest('.reward-item');
        const rewardTitle = rewardItem.querySelector('.reward-title').textContent;
        const rewardCost = parseInt(rewardItem.querySelector('.reward-cost').textContent.replace(/\D/g, ''));

        const userId = localStorage.getItem('userId');
        if (!userId) return;

        const data = getSavedRewardsData();
        
        if (data.totalPoints >= rewardCost) {
            if (confirm(`–û–±–º–µ–Ω—è—Ç—å ${rewardCost} –æ—á–∫–æ–≤ –Ω–∞ "${rewardTitle}"?`)) {
                // –°–ø–∏—Å—ã–≤–∞–µ–º –æ—á–∫–∏
                data.totalPoints -= rewardCost;
                saveRewardsData(data);
                updateRewardsUI(data);
                
                showToast(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏: ${rewardTitle}`, 'success');
            }
        } else {
            showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞', 'error');
        }
    }

    // === –õ–û–ì–ò–ö–ê –ü–û–î–ü–ò–°–ö–ò BAD FOX ===
    let isSubscriptionUpdating = false;

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
    async function loadSubscriptionStatus() {
        const userId = localStorage.getItem('userId');
        if (!userId) return;

        try {
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ - –∑–∞–ø—Ä–æ—Å –∫ API)
            const subscriptionData = await getSubscriptionStatus(userId);
            updateSubscriptionUI(subscriptionData);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞)
    async function getSubscriptionStatus(userId) {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ API
        // const response = await fetch('/api/subscription', {...});
        // return await response.json();
        
        // –î–ª—è –¥–µ–º–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage
        const saved = localStorage.getItem(`bad_fox_subscription_${userId}`);
        if (saved) {
            const data = JSON.parse(saved);
            if (new Date(data.expiryDate) > new Date()) {
                return {
                    isActive: true,
                    expiryDate: data.expiryDate,
                    startDate: data.startDate
                };
            }
        }
        
        return { isActive: false };
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–æ–¥–ø–∏—Å–∫–∏
    function updateSubscriptionUI(subscriptionData) {
        const profileSubscriptionStatus = document.getElementById('profile-subscription-status');
        const subscriptionExpiry = document.getElementById('subscription-expiry');
        const profileSubscriptionExpiry = document.getElementById('profile-subscription-expiry');
        const subscribeBtn = document.getElementById('subscribe-btn');
        const cancelBtn = document.getElementById('cancel-subscription-btn');
        const subscriptionStatusDisplay = document.getElementById('subscription-status-display');
        const actionsContainer = document.getElementById('subscription-actions');

        if (subscriptionData.isActive) {
            // –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
            if (profileSubscriptionStatus) {
                profileSubscriptionStatus.style.display = 'block';
                if (subscriptionExpiry) {
                    const expiryDate = new Date(subscriptionData.expiryDate);
                    const formattedDate = expiryDate.toLocaleDateString('ru-RU', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    profileSubscriptionExpiry.textContent = formattedDate;
                    subscriptionExpiry.textContent = formattedDate;
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            if (subscriptionStatusDisplay) {
                subscriptionStatusDisplay.style.display = 'block';
                subscriptionStatusDisplay.classList.add('active');
            }
            if (actionsContainer) {
                actionsContainer.style.display = 'none';
            }
            if (subscribeBtn) subscribeBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'block';
        } else {
            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞
            if (profileSubscriptionStatus) {
                profileSubscriptionStatus.style.display = 'none';
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            if (subscriptionStatusDisplay) {
                subscriptionStatusDisplay.style.display = 'none';
            }
            if (actionsContainer) {
                actionsContainer.style.display = 'block';
            }
            if (subscribeBtn) subscribeBtn.style.display = 'block';
            if (cancelBtn) cancelBtn.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    async function subscribeBadFox() {
        const userId = localStorage.getItem('userId');
        if (!userId) return;

        const subscribeBtn = document.getElementById('subscribe-btn');
        if (isSubscriptionUpdating || !subscribeBtn) return;

        isSubscriptionUpdating = true;
        subscribeBtn.textContent = '–ü–æ–¥–∫–ª—é—á–∞–µ–º...';
        subscribeBtn.disabled = true;

        try {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
            // const response = await fetch('/api/subscription/subscribe', {...});
            // const result = await response.json();
            
            // –î–ª—è –¥–µ–º–æ —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ–±–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 3 –¥–Ω—è
            const startDate = new Date();
            const expiryDate = new Date(startDate);
            expiryDate.setDate(expiryDate.getDate() + 3); // 3 –¥–Ω—è –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞

            const subscriptionData = {
                isActive: true,
                startDate: startDate.toISOString(),
                expiryDate: expiryDate.toISOString(),
                type: 'bad_fox',
                trialPeriod: true
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –¥–µ–º–æ
            localStorage.setItem(`bad_fox_subscription_${userId}`, JSON.stringify(subscriptionData));

            updateSubscriptionUI(subscriptionData);
            
            showToast('–ü–æ–¥–ø–∏—Å–∫–∞ Bad Fox –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –ü–µ—Ä–≤—ã–µ 3 –¥–Ω—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ.');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
            showToast('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
        } finally {
            isSubscriptionUpdating = false;
            if (subscribeBtn) {
                subscribeBtn.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∑–∞ 599‚ÇΩ/–º–µ—Å';
                subscribeBtn.disabled = false;
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏
    async function cancelSubscription() {
        const userId = localStorage.getItem('userId');
        if (!userId) return;

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É Bad Fox?\n\n–ü–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –¥–æ –∫–æ–Ω—Ü–∞ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.')) {
            return;
        }

        const cancelBtn = document.getElementById('cancel-subscription-btn');
        if (isSubscriptionUpdating || !cancelBtn) return;

        isSubscriptionUpdating = true;
        cancelBtn.textContent = '–û—Ç–º–µ–Ω—è–µ–º...';
        cancelBtn.disabled = true;

        try {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –æ—Ç–º–µ–Ω—ã –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è
            // const response = await fetch('/api/subscription/cancel', {...});
            
            // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –∏–∑ localStorage
            localStorage.removeItem(`bad_fox_subscription_${userId}`);

            updateSubscriptionUI({ isActive: false });
            
            showToast('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. –û–Ω–∞ –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞.');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏:', error);
            showToast('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
        } finally {
            isSubscriptionUpdating = false;
            if (cancelBtn) {
                cancelBtn.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
                cancelBtn.disabled = false;
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast-container toast-${type} hidden`;
        toast.innerHTML = `<p class="toast-message">${message}</p>`;
        
        document.body.appendChild(toast);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        setTimeout(() => toast.classList.remove('hidden'), 100);
        
        // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            toast.classList.add('hidden');
            setTimeout(() => document.body.removeChild(toast), 400);
        }, 4000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏
    function initSubscriptionHandlers() {
        const subscribeBtn = document.getElementById('subscribe-btn');
        const cancelBtn = document.getElementById('cancel-subscription-btn');

        if (subscribeBtn) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            subscribeBtn.replaceWith(subscribeBtn.cloneNode(true));
            const newSubscribeBtn = document.getElementById('subscribe-btn');
            newSubscribeBtn.addEventListener('click', subscribeBadFox);
            console.log('‚úÖ Subscribe button handler attached');
        }

        if (cancelBtn) {
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
            const newCancelBtn = document.getElementById('cancel-subscription-btn');
            newCancelBtn.addEventListener('click', cancelSubscription);
            console.log('‚úÖ Cancel button handler attached');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initSubscriptionHandlers();
    });
    </script>
</body>
</html>
